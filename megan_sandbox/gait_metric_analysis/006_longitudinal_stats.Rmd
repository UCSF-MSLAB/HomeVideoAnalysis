---
title: "Longitudal video metric analysis"
author: "Megan"
date: "2025-05-16"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(dplyr)
library(tidyr)
library(tidyverse)
library(ggplot2)
library(psych)
```


# set output directory 
```{r}
# analysis folder 
analysis_version <- '007'
```


```{r}
output_dir <- file.path("C:/Users/mmccu/Box/MM_Personal/5_Projects/BoveLab/3_Data_and_Code/gait_bw_zeno_home_analysis",
                    analysis_version, 
                    "006_longitudinal_v2_edssCutoffs")

ifelse(!dir.exists(output_dir), 
       dir.create(output_dir), 
       "directory already exists") 
```

# Load FW video data from participants with baseline and 1 year visits 
Formatted and filtered in jupyter notebook
```{r}
zv_fw_base_yr1_path <- file.path("C:/Users/mmccu/Box/MM_Personal/5_Projects/BoveLab/3_Data_and_Code/gait_bw_zeno_home_analysis",
                       analysis_version, 
                       "006_longitudinal", 
                       "fw_base_yr2_1_all.csv")

zv_fw_base_yr1_df <- read.csv(zv_fw_base_yr1_path)
```


# Make long dataset with subset of cols for analysis  
Select variables for analysis  
```{r}

zv_fw_base_yr1_long <- zv_fw_base_yr1_df %>% 
  select(bw_id, redcap_event_name, video_id_date_name_pose_zv, id_date_pose_zv, 
         delta_pix_h_rel_median_pose_zv, stride_time_median_sec_pose_zv, 
         mean_cadence_step_per_min_pose_zv, stride_width_median_cm_pose_zv,
         trialdate, clean_T25FW_Avg, clean_EDSS, msfcEHR_T25FW.SPEED.TRIAL.1.vDate.Diff, 
         demoEHR_EDSS_dateDiff) %>% 
  mutate(redcap_event_clean = ifelse(redcap_event_name == 'Brainwalk: Baseline visit (Arm 1: Baseline visit)',
                                   'baseline',
                                   'year2')) 

```

## Check date diffs clinical outcomes 

T25FW
```{r}
p1 <- ggplot(data = zv_fw_base_yr1_long, aes(x = msfcEHR_T25FW.SPEED.TRIAL.1.vDate.Diff)) + 
  geom_histogram() + 
  facet_grid(rows = vars(redcap_event_name))
p1

```


EDSS 
```{r}
p2 <- ggplot(data = zv_fw_base_yr1_long, aes(x = demoEHR_EDSS_dateDiff)) + 
  geom_histogram() + 
  facet_grid(rows = vars(redcap_event_name))
p2
```
# Make Wide Dataset 

pivot wider 
```{r}
zv_fw_base_yr1_df_wide <- zv_fw_base_yr1_long %>% 
  select(-redcap_event_name)%>% 
  pivot_wider(id_cols = bw_id, 
              names_from = redcap_event_clean, 
              values_from = -c(bw_id, redcap_event_clean))
```

## Calculate and plot date diff from baseline to year 1 follow up 

## Calculate minimal significant change 
reference - https://www.sciencedirect.com/science/article/pii/S0966636220306998?ref=pdf_download&fr=RR-2&rr=940e64c029f9cba0 
Christopher bramah et al 
ICC3k: A fixed set of k judges rate each target. There is no generalization to a larger population of judges.
Think this means MDC is restricted to this data set? not sure 
```{r}
calc_srd95 <- function(data, SD) {
  
  # Calculate ICC
  icc_result <- ICC(data)
  print(icc_result)
  icc_result_df <- as.data.frame(icc_result$results, rownames = "icc_type")

  # Extract ICC3k 
  ICC_value <- icc_result_df$ICC[icc_result_df$type == "ICC3k"]
  print(ICC_value)
  
  # Calculate SEM - standard error of measurement 
  SEM <- SD * sqrt(1 - ICC_value)
  print(SEM)
  
  # Calculate SRD 
  SRD <- round(1.96 *  SEM * sqrt(2), 3)
  print(SRD)
  
  return(SRD)
}


```


delta pixel SRD95
```{r}
pixel_df <- zv_fw_base_yr1_df_wide %>% 
  select(delta_pix_h_rel_median_pose_zv_baseline, 
         delta_pix_h_rel_median_pose_zv_year2)

pixel_sd <- sd(c(pixel_df$delta_pix_h_rel_median_pose_zv_baseline, 
              pixel_df$delta_pix_h_rel_median_pose_zv_year2))

pixel_SRD  <- calc_srd95(pixel_df, pixel_sd)
pixel_srd_df <- data.frame(pixel_SRD_value = round(pixel_SRD, 2))
write.csv(pixel_srd_df,
          file.path(output_dir, 
                    'change_pixel_SRD.csv'))
```

stride time SRD95
```{r}
stride_time_df <-  zv_fw_base_yr1_df_wide %>% 
  select(stride_time_median_sec_pose_zv_baseline, 
         stride_time_median_sec_pose_zv_year2)

stride_time_sd <- sd(c(stride_time_df$stride_time_median_sec_pose_zv_baseline,
                       stride_time_df$stride_time_median_sec_pose_zv_year2))

stride_time_SRD <- calc_srd95(stride_time_df, stride_time_sd)
stride_time_srd_df <- data.frame(stride_time_SRD_value = round(stride_time_SRD, 2))
write.csv(stride_time_srd_df,
          file.path(output_dir, 
                    'change_stride_time_SRD.csv'))
```

## Visualize - paired boxplot from baseline to year2
```{r}
# Pixel Proxy 
ggplot(zv_fw_base_yr1_long, aes(x = redcap_event_name, y = delta_pix_h_rel_median_pose_zv)) +
  geom_boxplot(outlier.shape = NA, fill = "lightblue", width = 0.4) +
  geom_jitter(width = 0.1, aes(group = bw_id), alpha = 0.6, color = "black") +
  geom_line(aes(group = bw_id), color = "gray", alpha = 0.5) +
  theme_minimal() +
  labs(x = "Timepoint", y = "Pixel Proxy Median")


# Stride Time 
ggplot(zv_fw_base_yr1_long, aes(x = redcap_event_name, y = stride_time_median_sec_pose_zv)) +
  geom_boxplot(outlier.shape = NA, fill = "lightblue", width = 0.4) +
  geom_jitter(width = 0.1, aes(group = bw_id), alpha = 0.6, color = "black") +
  geom_line(aes(group = bw_id), color = "gray", alpha = 0.5) +
  theme_minimal() +
  labs(y = "Stride Time Median")


# T25FW 
ggplot(zv_fw_base_yr1_long, aes(x = redcap_event_name, y = clean_T25FW_Avg)) +
  geom_boxplot(outlier.shape = NA, fill = "lightblue", width = 0.4) +
  geom_jitter(width = 0.1, aes(group = bw_id), alpha = 0.6, color = "black") +
  geom_line(aes(group = bw_id), color = "gray", alpha = 0.5) +
  theme_minimal() +
  labs(y = "T25FW")


# EDSS
ggplot(zv_fw_base_yr1_long, aes(x = redcap_event_name, y = clean_EDSS)) +
  geom_boxplot(outlier.shape = NA, fill = "lightblue", width = 0.4) +
  geom_jitter(width = 0.1, aes(group = bw_id), alpha = 0.6, color = "black") +
  geom_line(aes(group = bw_id), color = "gray", alpha = 0.5) +
  theme_minimal() +
  labs(y = "EDSS")
```


## Calculate changes from baseline to year 2 
 
```{r}
tidy_wilcox <- function(test_object) {
  results_df <- data.frame(
    statistic = test_object$statistic,
    p_value = test_object$p.value,
    p_formatted = ifelse(test_object$p.value <0.001, '<0.001', round(test_object$p.value, 3)), 
    method = test_object$method,
    alternative = test_object$alternative
  ) %>% 
    mutate(p_formatted = as.character(p_formatted))
  
  
  return(results_df)
}
```

Year 2 values - baseline visit
```{r}
zv_fw_base_yr1_df_wide <- zv_fw_base_yr1_df_wide %>% 
  mutate(trialdate_diff_days = as.Date(trialdate_year2) - as.Date(trialdate_baseline),
         delta_pix_h_diff = delta_pix_h_rel_median_pose_zv_year2 - delta_pix_h_rel_median_pose_zv_baseline, 
         stride_time_diff = stride_time_median_sec_pose_zv_year2 - stride_time_median_sec_pose_zv_baseline, 
         t25fw_diff = clean_T25FW_Avg_year2 - clean_T25FW_Avg_baseline, 
         edss_diff = clean_EDSS_year2 - clean_EDSS_baseline) 

head(zv_fw_base_yr1_df_wide)
summary(zv_fw_base_yr1_df_wide)

```
### Date Diff 
```{r}
summary(as.numeric(zv_fw_base_yr1_df_wide$trialdate_diff_days))
hist(as.numeric(zv_fw_base_yr1_df_wide$trialdate_diff_days), probability = TRUE)
```

### Stats tests 
```{r}
# check the distribution of diff visually

hist(as.numeric(zv_fw_base_yr1_df_wide$delta_pix_h_diff), probability = TRUE)
hist(as.numeric(zv_fw_base_yr1_df_wide$stride_time_diff), probability = TRUE)
hist(as.numeric(zv_fw_base_yr1_df_wide$t25fw_diff), probability = TRUE)
hist(as.numeric(zv_fw_base_yr1_df_wide$edss_diff), probability = TRUE)

# Performs the Shapiro-Wilk test of normality
shapiro.test(as.numeric(zv_fw_base_yr1_df_wide$delta_pix_h_diff))
shapiro.test(as.numeric(zv_fw_base_yr1_df_wide$stride_time_diff))
shapiro.test(as.numeric(zv_fw_base_yr1_df_wide$t25fw_diff))
shapiro.test(as.numeric(zv_fw_base_yr1_df_wide$edss_diff))

# interpretation notes - delta pix h diff only normally distributed by shaprio test
# but... doesn't look normal on left end of plot, running wilcoxon signed rank test 
# for assumption not met for all variables 

# Performs a Wilcoxon Signed-Rank test if paired-data t-test assumption are not met
# delta pixel 
pixel_wcx_results <- wilcox.test(zv_fw_base_yr1_df_wide$delta_pix_h_rel_median_pose_zv_year2,
                                 zv_fw_base_yr1_df_wide$delta_pix_h_rel_median_pose_zv_baseline, 
                                 paired = TRUE,
                                 correct = FALSE, 
                                 exact = FALSE)

pixel_wcx_df <- tidy_wilcox(pixel_wcx_results) %>% 
  mutate(median_diff = round(median(zv_fw_base_yr1_df_wide$delta_pix_h_diff), 2), 
         q1 = round(quantile(zv_fw_base_yr1_df_wide$delta_pix_h_diff, probs = 0.25), 2),
         q3 = round(quantile(zv_fw_base_yr1_df_wide$delta_pix_h_diff, probs = 0.75), 2),
         data_name = pixel_wcx_results$data.name,
         name_clean = 'Pixel Height Proxy')

# stride time 
stride_wcx_results <- wilcox.test(zv_fw_base_yr1_df_wide$stride_time_median_sec_pose_zv_year2,
                                 zv_fw_base_yr1_df_wide$stride_time_median_sec_pose_zv_baseline, 
                                 paired = TRUE,
                                 correct = FALSE, 
                                 exact = FALSE)

stride_wcx_df <-tidy_wilcox(stride_wcx_results) %>%
  mutate(median_diff = round(median(zv_fw_base_yr1_df_wide$stride_time_diff), 2), 
         q1 = round(quantile(zv_fw_base_yr1_df_wide$stride_time_diff, probs = 0.25), 2),
         q3 = round(quantile(zv_fw_base_yr1_df_wide$stride_time_diff, probs = 0.75), 2), 
         data_name = stride_wcx_results$data.name, 
         name_clean = 'Stride Time')

# T25FW 
t25fw_wcx_results <- wilcox.test(zv_fw_base_yr1_df_wide$clean_T25FW_Avg_year2,
                                 zv_fw_base_yr1_df_wide$clean_T25FW_Avg_baseline, 
                                 paired = TRUE,
                                 correct = FALSE, 
                                 exact = FALSE)

t25fw_wcx_df <- tidy_wilcox(t25fw_wcx_results) %>%
  mutate(median_diff = round(median(zv_fw_base_yr1_df_wide$t25fw_diff), 2), 
         q1 = round(quantile(zv_fw_base_yr1_df_wide$t25fw_diff, probs = 0.25), 2),
         q3 = round(quantile(zv_fw_base_yr1_df_wide$t25fw_diff, probs = 0.75), 2),
         data_name = t25fw_wcx_results$data.name, 
         name_clean = 'T25FW') 

# EDSS 
edss_wcx_results <- wilcox.test(zv_fw_base_yr1_df_wide$clean_EDSS_year2,
                                 zv_fw_base_yr1_df_wide$clean_EDSS_baseline, 
                                 paired = TRUE,
                                 correct = FALSE, 
                                 exact = FALSE)

edss_wcx_df <- tidy_wilcox(edss_wcx_results) %>% 
  mutate(median_diff = round(median(zv_fw_base_yr1_df_wide$edss_diff), 2), 
         q1 = round(quantile(zv_fw_base_yr1_df_wide$edss_diff, probs = 0.25), 2),
         q3 = round(quantile(zv_fw_base_yr1_df_wide$edss_diff, probs = 0.75), 2),
         data_name = edss_wcx_results$data.name, 
         name_clean = 'EDSS')

```

```{r}
# bind and save all wilcoxong results 
wcx_df_all <- bind_rows(pixel_wcx_df, stride_wcx_df, t25fw_wcx_df, edss_wcx_df)
wcx_df_all
write.csv(wcx_df_all, 
          file.path(output_dir, 'fw_bw_tests_change_over_year.csv'))
```

## Increased/Decrease/No Change 

### Add new columns for change 
Continuous change 
```{r}
 
zv_fw_base_yr1_df_wide <- zv_fw_base_yr1_df_wide %>% 
  mutate(delta_pix_change_cont = ifelse(delta_pix_h_diff == 0, 
                                         'No Change', 
                                         ifelse(delta_pix_h_diff > 0, 
                                                'Improved', 
                                                'Worsened')),
         stride_time_change_cont = ifelse(stride_time_diff == 0,
                                          'No Change', 
                                          ifelse(stride_time_diff > 0,
                                                 'Worsened',
                                                 'Improved')), 
         t25fw_change_cont = ifelse(t25fw_diff == 0, 
                                    'No Change', 
                                    ifelse(t25fw_diff > 0,
                                           'Worsened', 
                                           'Improved')), 
         edss_change_cont = ifelse(edss_diff == 0, 
                                   'No Change', 
                                   ifelse(edss_diff > 0,
                                          'Worsened',
                                          'Improved'))) 


```

Categorical Change 
If T25FW changes by more than 20% of baseline T25FW or video metrics change by more than SRD value 
== Change 

```{r}
zv_fw_base_yr1_df_wide <- zv_fw_base_yr1_df_wide %>% 
  mutate(delta_pix_change_cat = ifelse(abs(delta_pix_h_diff) < pixel_SRD, 
                                        'No Change',
                                        ifelse(delta_pix_h_diff > 0,
                                               'Improved', 
                                               'Worsened')), 
         stride_time_change_cat = ifelse(abs(stride_time_diff) < stride_time_SRD,
                                         'No Change', 
                                         ifelse(stride_time_diff > 0,
                                                'Worsened', 
                                                'Improved')), 
         t25fw_change_cat = ifelse(abs(t25fw_diff) < .2 * clean_T25FW_Avg_baseline, 
                                   'No Change', 
                                   ifelse(t25fw_diff > 0,
                                   'Worsened', 
                                   'Improved')),
         
         edss_change_cat = ifelse(clean_EDSS_baseline == 0 & edss_diff >= 1.5,
                                  'Worsened', 
                                  ifelse(clean_EDSS_baseline >= 1.0 & clean_EDSS_baseline <=5.0 & edss_diff >= 1.0,
                                         'Worsened', 
                                         ifelse(clean_EDSS_baseline >= 5.5 & edss_diff >= 0.5,
                                                'Worsened',
                                                'Other')))
         )
                                           
```

Binary - worsened yes no 

```{r}
zv_fw_base_yr1_df_wide <- zv_fw_base_yr1_df_wide %>% 
  mutate(delta_pix_worsenYN_cont = ifelse(delta_pix_change_cont == 'Worsened', 
                                           'Yes', 'No'), 
         stride_time_worsenYN_cont = ifelse(stride_time_change_cont == 'Worsened',
                                        'Yes', 'No'), 
         t25fw_worsenYN_cont = ifelse(t25fw_change_cont == 'Worsened',
                                      'Yes', 'No'), 
         edss_worsenYN_cont = ifelse(edss_change_cont == 'Worsened',
                                     'Yes', 'No'), 
         delta_pix_worsenYN_cat = ifelse(delta_pix_change_cat == 'Worsened',
                                         'Yes', 'No'), 
         stride_time_worsenYN_cat = ifelse(stride_time_change_cat == 'Worsened',
                                           'Yes', 'No'), 
         t25fw_worsenYN_cat = ifelse(t25fw_change_cat == 'Worsened',
                                     'Yes', 'No'), 
         edss_worsenYN_cat = ifelse(edss_change_cat == 'Worsened', 
                                    'Yes', 'No'))

write.csv(zv_fw_base_yr1_df_wide,
          file.path(output_dir, 
                    'fw_base_yer2_wide_groups.csv')) 
         
         
```


```{r}
print('t25fw_worsenYN_cont')
print(table(zv_fw_base_yr1_df_wide$t25fw_worsenYN_cont))

print('t25fw_worsenYN_cat')
print(table(zv_fw_base_yr1_df_wide$t25fw_worsenYN_cat))
```

```{r}
print('edss_worsenYN_cont')
print(table(zv_fw_base_yr1_df_wide$edss_worsenYN_cont))

print('edss_worsenYN_cat')
print(table(zv_fw_base_yr1_df_wide$edss_worsenYN_cat))
```

```{r}
print('delta_pix_worsenYN_cont')
print(table(zv_fw_base_yr1_df_wide$delta_pix_worsenYN_cont))

print('delta_pix_worsenYN_cat')
print(table(zv_fw_base_yr1_df_wide$delta_pix_worsenYN_cat))

```
```{r}
print('stride_time_worsenYN_cont')
print(table(zv_fw_base_yr1_df_wide$stride_time_worsenYN_cont))

print('stride_time_worsenYN_cat')
print(table(zv_fw_base_yr1_df_wide$stride_time_worsenYN_cat))

```

## Create new column for following: 
Worsened in both video and clinical = 1
Worsened clinical measure only = 2
Worsened video measure only = 3
Worsened in neither video or clinical = 4

column name = videometric_vs_clinicalmetric_datatype_groups 
```{r}
add_video_vs_clinical_groups <- function(df, video_col, clinical_col, new_col_name) {
  df[[new_col_name]] <- with(df, ifelse(df[[video_col]] == "Yes" & df[[clinical_col]] == "Yes", 'Both', # both 
                                 ifelse(df[[video_col]] == "No" & df[[clinical_col]] == "Yes", 'Clinical Only', # clinical only
                                 ifelse(df[[video_col]] == "Yes"  & df[[clinical_col]] == "No", 'Video Only', # video only 
                                                                    'Neither')))) # neither 
  df[[new_col_name]] <- as.factor(df[[new_col_name]])
  return(df)
}

```

### T25FW Continuous vs Video Continuous 
```{r}
# delta pixel 
zv_fw_base_yr1_df_wide <- add_video_vs_clinical_groups(zv_fw_base_yr1_df_wide, 
                                                       'delta_pix_worsenYN_cont',
                                                       't25fw_worsenYN_cont',
                                                       't25fw_cont_vs_pixel_cont_groups')

table(zv_fw_base_yr1_df_wide$t25fw_cont_vs_pixel_cont_groups)

```

```{r}
# stride time 
zv_fw_base_yr1_df_wide <- add_video_vs_clinical_groups(zv_fw_base_yr1_df_wide, 
                                                       'stride_time_worsenYN_cont',
                                                       't25fw_worsenYN_cont',
                                                       't25fw_cont_vs_stride_cont_groups')

table(zv_fw_base_yr1_df_wide$t25fw_cont_vs_stride_cont_groups)
```

### T25FW Categorical vs Video Categorical 
```{r}
# Delta pixel 
zv_fw_base_yr1_df_wide <- add_video_vs_clinical_groups(zv_fw_base_yr1_df_wide, 
                                                       'delta_pix_worsenYN_cat',
                                                       't25fw_worsenYN_cat',
                                                       't25fw_cat_vs_pixel_cat_groups')

table(zv_fw_base_yr1_df_wide$t25fw_cat_vs_pixel_cat_groups)

```
```{r}
# Stride Time 
zv_fw_base_yr1_df_wide <- add_video_vs_clinical_groups(zv_fw_base_yr1_df_wide, 
                                                       'stride_time_worsenYN_cat',
                                                       't25fw_worsenYN_cat',
                                                       't25fw_cat_vs_stride_cat_groups')

table(zv_fw_base_yr1_df_wide$t25fw_cat_vs_stride_cat_groups)
```

### EDSS continuous vs Video Continuous 
```{r}
# pixel 
zv_fw_base_yr1_df_wide <- add_video_vs_clinical_groups(zv_fw_base_yr1_df_wide, 
                                                       'delta_pix_worsenYN_cont',
                                                       'edss_worsenYN_cont',
                                                       'edss_cont_vs_pixel_cont_groups')

table(zv_fw_base_yr1_df_wide$edss_cont_vs_pixel_cont_groups)

```
```{r}
# stride time 
zv_fw_base_yr1_df_wide <- add_video_vs_clinical_groups(zv_fw_base_yr1_df_wide, 
                                                       'stride_time_worsenYN_cont',
                                                       'edss_worsenYN_cont',
                                                       'edss_cont_vs_stride_cont_groups')

table(zv_fw_base_yr1_df_wide$edss_cont_vs_stride_cont_groups)
```
### EDSS categorical vs video categorical 
```{r}
# pixel 
zv_fw_base_yr1_df_wide <- add_video_vs_clinical_groups(zv_fw_base_yr1_df_wide, 
                                                       'delta_pix_worsenYN_cat',
                                                       'edss_worsenYN_cat',
                                                       'edss_cat_vs_pixel_cat_groups')

table(zv_fw_base_yr1_df_wide$edss_cat_vs_pixel_cat_groups)
```

```{r}
# stride time 
zv_fw_base_yr1_df_wide <- add_video_vs_clinical_groups(zv_fw_base_yr1_df_wide, 
                                                       'stride_time_worsenYN_cat',
                                                       'edss_worsenYN_cat',
                                                       'edss_cat_vs_stride_cat_groups')

table(zv_fw_base_yr1_df_wide$edss_cat_vs_pixel_cat_groups)
```


## Plot 
Plot all

```{r}
# convert to long dataframe 
plot_long_df <- zv_fw_base_yr1_df_wide %>% 
  select(c(bw_id, ends_with('groups'))) %>% 
  pivot_longer(cols = ends_with('groups'), 
               names_to = 'cols_compared', 
               values_to = 'agreement_group') %>% 
  mutate(clinical_outcome = ifelse(grepl("t25fw_cont", cols_compared), 
                               'T25FW Continuous', 
                               ifelse(grepl("t25fw_cat", cols_compared),
                                      'T25FW Categorical', 
                                      ifelse(grepl('edss_cont', cols_compared),
                                             'EDSS Ordinal',
                                             ifelse(grepl('edss_cat', cols_compared),
                                                    'EDSS Categorical', 
                                                    'Other'))))) %>%   # add column for outcome 
  mutate(video_metric = ifelse(grepl('pixel_cont', cols_compared), 
                               'Pixel Proxy Continuous', 
                               ifelse(grepl('pixel_cat', cols_compared), 
                                      'Pixel Proxy Categorical', 
                                      ifelse(grepl('stride_cont', cols_compared),
                                             'Stride Time Continuous',
                                             ifelse(grepl('stride_cat', cols_compared),
                                                    'Stride Time Categorical',
                                                    'Other'))))) # add column for video metric 



# factor: agreement_group
plot_long_df$agreement_group <- factor(plot_long_df$agreement_group, 
                                       levels = c('Video Only', 'Clinical Only', 'Both', 'Neither'), 
                                       labels = c('Video metric only', 
                                                  'Clinical outcome only', 
                                                  'Both',
                                                  'Neither'))


ggplot(data = plot_long_df, aes(x = video_metric, fill = agreement_group)) + 
  geom_bar(position = 'fill') + 
  facet_grid(rows = vars(clinical_outcome)) +
   scale_fill_brewer(name = 'Worsened by:', palette = "Set2") +
  labs(y = "Proportion", x = "") +
  theme_minimal() + 
  theme(legend.position = 'bottom')
```
Final plot
Remove EDSS vs categorical video metrics, no categorical EDSS grouping 
Remove continuous T25FW vs categorical video metrics - not comparing the same thing


Figure legend 
left: EDSS vs continuous video metrics 
middle: continuous25FW vs continuous video metrics 
left: categorical T25FW (change by 20% or more) and video metric categorical (change of SRD95 or more)

left vs middle: both continuous video metrics, higher % showing change in video metric only in EDSS. Continuous video metrics more sensitive to change than EDSS (% with decrease in . T25FW continous 

Right:categorical - strong agreement between videos and T25Fw - % both and neither in these groups 

```{r}

exclude_strings <- c('edss_cont_vs_pixel_cat_groups',
                     'edss_cont_vs_stride_cat_groups',
                     "t25fw_cont_vs_pixel_cat_groups",
                     't25fw_cont_vs_stride_cat_groups'
                     )

plot_long_df_2 <- plot_long_df %>%  
  filter(!grepl(paste(exclude_strings, collapse="|"), cols_compared))

# make new columns 
# only comparing stride time categorical and pixel categorical to T25FW categorical 
# same for continuou 
# don't need to specificy categorical or continuous on plot 
plot_long_df_2 <- plot_long_df_2 %>% 
  mutate(video_metric_simple = ifelse(grepl('Pixel Proxy', video_metric),
                                      'Pixel Proxy', 
                                      ifelse(grepl('Stride Time', video_metric),
                                             'Stride Time', 
                                             'Other')))

print(table(plot_long_df_2$clinical_outcome, plot_long_df_2$video_metric)) # confirm

# factor clinical outcome variable - control order of facet_wrap
plot_long_df_2$clinical_outcome <- factor(plot_long_df_2$clinical_outcome, 
                                          levels = c('T25FW Continuous', 'T25FW Categorical',
                                                     'EDSS Ordinal', 'EDSS Categorical'))


ggplot(data = plot_long_df_2, aes(x = video_metric_simple, fill = agreement_group)) + 
  geom_bar(position = 'fill') + 
  facet_wrap(~clinical_outcome) +
   scale_fill_brewer(name = 'Worsened by:', palette = "Set2") +
  labs(y = "Proportion", x = "Video Metric") +
  theme_minimal() + 
  theme(legend.position = 'bottom')


# add proportion column to put text on plot 
plot_long_df_2_prop <- plot_long_df_2 %>%
  group_by(clinical_outcome, video_metric_simple, agreement_group) %>%
  summarise(n = n(), .groups = "drop") %>%
  group_by(clinical_outcome, video_metric_simple) %>%
  mutate(prop = n / sum(n),
         label = scales::percent(prop, accuracy = 1))

# proportion 
p <- ggplot(plot_long_df_2_prop, aes(x = video_metric_simple, y = prop, fill = agreement_group)) +
  geom_bar(stat = "identity", position = "fill", width = 0.5) +
  geom_text(aes(label = ifelse(prop > 0.03, label, "")),  # Only label if > 5%
            position = position_fill(vjust = 0.5),
            size = 3.25) + 
  facet_wrap(~ clinical_outcome) +
   scale_fill_brewer(name = "Worsened by:", palette = "Set2") +
  labs(y = "Proportion", x = "") +
  theme_minimal() + 
  theme(plot.title = element_text(size = 9, face = 'bold', hjust = 0.5),
          axis.title = element_text(size = 9),
          #axis.text = element_text(size = 9),
          axis.text.x = element_text(size = 9, face = 'italic'),
          axis.text.y = element_blank(),
          axis.title.y = element_blank(),
          axis.ticks.y = element_blank(),
          legend.text = element_text(size = 9), 
          legend.title = element_text(size = 9),
          legend.position = 'bottom',
          legend.key.size = unit(0.5, "lines"))  
p
ggsave(file.path(output_dir, 'barcharts_proportion.png'),
       bg = 'white', height = 5, width = 5)


# Number 
p <- ggplot(plot_long_df_2_prop, aes(x = video_metric_simple, y = prop, fill = agreement_group)) +
  geom_bar(stat = "identity", position = "fill") +
  geom_text(aes(label = n),
            position = position_fill(vjust = 0.5), size = 4) +
  facet_wrap(~ clinical_outcome) +
   scale_fill_brewer(name = "Worsened by:", palette = "Set2") +
  labs(y = "Proportion", x = "Video Metric") +
  theme_minimal() 
p
ggsave(file.path(output_dir, 'barcharts_count.png'),
       bg = 'white', height = 4, width = 4)
```

## OLD 
### EDSS Categorical vs Video continuous 
```{r}
# pixel 
zv_fw_base_yr1_df_wide <- add_video_vs_clinical_groups(zv_fw_base_yr1_df_wide, 
                                                       'delta_pix_worsenYN_cat',
                                                       'edss_worsenYN_cont',
                                                       'edss_cont_vs_pixel_cat_groups')

table(zv_fw_base_yr1_df_wide$edss_cont_vs_pixel_cat_groups)

```
```{r}
# stride time 
zv_fw_base_yr1_df_wide <- add_video_vs_clinical_groups(zv_fw_base_yr1_df_wide, 
                                                       'stride_time_worsenYN_cat',
                                                       'edss_worsenYN_cont',
                                                       'edss_cont_vs_stride_cat_groups')

table(zv_fw_base_yr1_df_wide$edss_cont_vs_stride_cat_groups)

```

### T25FW Continuous vs Video Categorical 
```{r}
# delta pixel 
zv_fw_base_yr1_df_wide <- add_video_vs_clinical_groups(zv_fw_base_yr1_df_wide, 
                                                       'delta_pix_worsenYN_cat',
                                                       't25fw_worsenYN_cont',
                                                       't25fw_cont_vs_pixel_cat_groups')

table(zv_fw_base_yr1_df_wide$t25fw_cont_vs_pixel_cat_groups)
```
```{r}
# Stride Time 

zv_fw_base_yr1_df_wide <- add_video_vs_clinical_groups(zv_fw_base_yr1_df_wide, 
                                                       'stride_time_worsenYN_cat',
                                                       't25fw_worsenYN_cont',
                                                       't25fw_cont_vs_stride_cat_groups')

table(zv_fw_base_yr1_df_wide$t25fw_cont_vs_stride_cat_groups)
```

