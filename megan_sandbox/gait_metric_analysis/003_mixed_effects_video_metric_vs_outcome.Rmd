---
title: "Mixed Effect Models"
author: "Megan"
date: "2025-03-13"
output: html_document
---

Mixed effects models - random effects by participant ID 
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(readxl)
library(dplyr)
library(tidyverse)
library(ggplot2)
library(broom.mixed)
library(lme4)
library(lmerTest)
library(performance)

```

# Rationale 
Used correlation between predictor and outcomes to select metrics to use in analysis. 
Reviewed "check outcome transorm" section plots to select outcome (original, log, sqrt, etc)


# Set directories and load data 
## output directory 
```{r}
# analysis folder 
analysis_version <- '011'

```

```{r}
output_dir <- file.path("C:/Users/mmccu/Box/MM_Personal/5_Projects/BoveLab/3_Data_and_Code/gait_bw_zeno_home_analysis",
                        analysis_version, 
                        "003_mixed_effects_models")

# create output folder if it doesn't already exist 
if (file.exists(output_dir) == FALSE){
  dir.create(output_dir)
}
```

## Load and format PWS data   
All videos included in analysis. 

Each row = 1 video 

```{r}
# Preferred Walking Speed 
zeno_pws_path <- file.path("C:/Users/mmccu/Box/MM_Personal/5_Projects/BoveLab/3_Data_and_Code/gait_bw_zeno_home_analysis", 
                           analysis_version, 
                           "000_merged_cleaned_data",
                           "zv_bw_merged_gait_vertical_PWS_1_clean.csv")
zeno_pws_df <- read.csv(zeno_pws_path)
table(zeno_pws_df$task_pose)
```
### Factor categorical vars 
```{r}
zeno_pws_df <- zeno_pws_df %>% 
  mutate_at(c("video_id_date_name_pose_zv", "id_date_pose_zv", "task_pose_zv", 
              "id_video", "bw_id", "clean_Sex", "bingoEHR_DX_MS.DX", 
              "demographic_diagnosis", "race_ethnicity_clean", 
              "race_ethnicity_clean", "ms_dx_condensed",
              "redcap_event_name", "clean_EDSS"), 
            as.factor)

# assign levels to categorical variables 
table(zeno_pws_df$race_ethnicity_clean)
zeno_pws_df$race_ethnicity_clean <- factor(zeno_pws_df$race_ethnicity_clean, 
                                           levels = c('White Non Hispanic', 
                                                      'Asian', 
                                                      'Black Or African American',
                                                      'Hispanic or Latino',
                                                      'Other/Unknown/Declined'), 
                                           ordered = FALSE)
print(levels(zeno_pws_df$race_ethnicity_clean))

table(zeno_pws_df$ms_dx_condensed)
zeno_pws_df$ms_dx_condensed <- factor(zeno_pws_df$ms_dx_condensed, 
                                      levels = c('RRMS', 
                                                 'Progressive MS',
                                                 'MS, Subtype Not Specified'), 
                                      ordered = FALSE)
print(levels(zeno_pws_df$ms_dx_condensed))

table(zeno_pws_df$clean_Sex)
zeno_pws_df$clean_Sex <- factor(zeno_pws_df$clean_Sex, 
                                levels = c('Female', 
                                           'Male',
                                           'Non-Binary'), 
                                ordered = FALSE)
print(levels(zeno_pws_df$clean_Sex))

table(zeno_pws_df$edss_severity_cat)
zeno_pws_df$edss_severity_cat <- factor(zeno_pws_df$edss_severity_cat, 
                                        levels = c('mild', 
                                                   'moderate',
                                                   'severe'), 
                                        ordered = TRUE)
print(levels(zeno_pws_df$edss_severity_cat))
print(table(zeno_pws_df$edss_severity_cat))
```

### Visit types 
```{r}
table(zeno_pws_df$redcap_event_name)
```


## Load and format FW data   
All videos included in analysis. 

Each row = 1 video 
```{r}
zeno_fw_path <- file.path("C:/Users/mmccu/Box/MM_Personal/5_Projects/BoveLab/3_Data_and_Code/gait_bw_zeno_home_analysis", 
                          analysis_version, 
                          "000_merged_cleaned_data", 
                          "zv_bw_merged_gait_vertical_FW_1_clean.csv")
zeno_fw_df <- read.csv(zeno_fw_path)
table(zeno_fw_df$task_pose)
```

### Factor categorical vars 
```{r}
zeno_fw_df <- zeno_fw_df %>% 
  mutate_at(c("video_id_date_name_pose_zv", "id_date_pose_zv", "task_pose_zv", 
              "id_video", "bw_id", "clean_Sex", "bingoEHR_DX_MS.DX", 
              "demographic_diagnosis", "race_ethnicity_clean", 
              "race_ethnicity_clean", "ms_dx_condensed",
              "redcap_event_name", "clean_EDSS"), 
            as.factor)

# assign levels to categorical variables 
table(zeno_fw_df$race_ethnicity_clean)

zeno_fw_df$race_ethnicity_clean <- factor(zeno_fw_df$race_ethnicity_clean, 
                                          levels = c('White Non Hispanic', 
                                                     'Asian', 
                                                     'Black Or African American',
                                                     'Hispanic or Latino',
                                                     'Other/Unknown/Declined'), 
                                          ordered = FALSE)
print(levels(zeno_fw_df$race_ethnicity_clean))

table(zeno_fw_df$ms_dx_condensed)
zeno_fw_df$ms_dx_condensed <- factor(zeno_fw_df$ms_dx_condensed, 
                                     levels = c('RRMS', 
                                                'Progressive MS',
                                                'MS, Subtype Not Specified'), 
                                     ordered = FALSE)
print(levels(zeno_fw_df$ms_dx_condensed))

table(zeno_fw_df$clean_Sex)
zeno_fw_df$clean_Sex <- factor(zeno_fw_df$clean_Sex, 
                               levels = c('Female', 
                                          'Male',
                                          'Non-Binary'), 
                               ordered = FALSE)
print(levels(zeno_fw_df$clean_Sex))

table(zeno_fw_df$edss_severity_cat)
zeno_fw_df$edss_severity_cat <- factor(zeno_fw_df$edss_severity_cat, 
                                levels = c('mild', 
                                           'moderate',
                                           'severe'), 
                                ordered = TRUE)
print(levels(zeno_fw_df$edss_severity_cat))
```

### Visit types 
```{r}
table(zeno_fw_df$redcap_event_name)
```

## Load and format Home video data 
```{r}
home_path <- file.path("C:/Users/mmccu/Box/MM_Personal/5_Projects/BoveLab/3_Data_and_Code/gait_bw_zeno_home_analysis",
                       analysis_version, 
                       "000_merged_cleaned_data", 
                       "hv_bw_merged_clean.csv")
home_df <- read.csv(home_path)
nrow(home_df)
table(home_df$demographic_diagnosis)
table(home_df$task_pose_hv)
```
### Factor categorical vars 
```{r}
home_df <- home_df %>% 
  mutate_at(c("video_id_date_name_pose_hv", "id_date_pose_hv", "task_pose_hv", 
              "id_video", "bw_id", "clean_Sex", "bingoEHR_DX_MS.DX", 
              "demographic_diagnosis", "race_ethnicity_clean", 
              "race_ethnicity_clean", "ms_dx_condensed",
              "redcap_event_name", "clean_EDSS"), 
            as.factor)

# assign levels to categorical variables 
table(home_df$race_ethnicity_clean)

home_df$race_ethnicity_clean <- factor(home_df$race_ethnicity_clean, 
                                       levels = c('White Non Hispanic', 
                                                  'Asian', 
                                                  'Black Or African American',
                                                  'Hispanic or Latino',
                                                  'Other/Unknown/Declined'), 
                                       ordered = FALSE)
print(levels(home_df$race_ethnicity_clean))

table(home_df$ms_dx_condensed)
home_df$ms_dx_condensed <- factor(home_df$ms_dx_condensed, 
                                  levels = c('RRMS', 
                                             'Progressive MS',
                                             'MS, Subtype Not Specified'), 
                                  ordered = FALSE)
print(levels(zeno_fw_df$ms_dx_condensed))

table(zeno_fw_df$clean_Sex)
zeno_fw_df$clean_Sex <- factor(zeno_fw_df$clean_Sex, 
                               levels = c('Female', 
                                          'Male',
                                          'Non-Binary'), 
                               ordered = FALSE)
print(levels(home_df$clean_Sex))

table(home_df$edss_severity_cat)
home_df$edss_severity_cat <- factor(home_df$edss_severity_cat, 
                                levels = c('mild', 
                                           'moderate',
                                           'severe'), 
                                ordered = TRUE)
print(levels(home_df$edss_severity_cat))
```

### Visit types 
```{r}
# of right turning videos and left turning videos 
table(home_df$task_pose_hv)

# videos per timepoint - most people sent two videos per timepoint 
# some sent first videos at year 2 or year 3 visit, not necessarily a true follow up 
table(home_df$redcap_event_name)
```
### Date diff histograms 
```{r}
ggplot(data = home_df, aes(bw_hv_date_diff_days)) + 
  geom_histogram()
```


# Functions 
## Plot outcome vs predictor 
Check data transforms and confirm which is the best to use 

```{r}
plot_outcome_transforms_vs_predictors <- function(df, outcome_cols, dataset_name, out_path){
  
  scatter_dir = file.path(out_path, 'scatter', dataset_name)
  
  if (file.exists(scatter_dir) == FALSE){
    dir.create(scatter_dir)
  }
  
  # remove hv or zv pattern in column name for consistency 
  colnames(df) <- gsub("pose_zv", "pose", colnames(df))
  colnames(df) <- gsub("pose_hv", "pose", colnames(df))
  
  
  # metrics
  x_metric_cols <- c("delta_pix_h_rel_median_pose", 
                     "log_delta_pix_h_rel_median_pose",
                     "stride_time_median_sec_pose",
                     "mean_cadence_step_per_min_pose", 
                     "stride_width_median_cm_pose",
                     "stance_time_per_mean_pose",
                     "tot_dsupport_per_mean_pose", 
                     "singlesupport_per_mean_pose",
                     "tot_dsupport_time_sec_std_pose",
                     "singlesupport_time_sec_std_pose"
                     )  


  for (i_x in seq_along(x_metric_cols)){
    print('--------------------------------------')
    x_metric_col <- x_metric_cols[i_x]
    print(x_metric_col)
    
    for (i_y in seq_along(outcome_cols)) {
      y_outcome_col <- outcome_cols[i_y]
      print(y_outcome_col)
      
      # Create temporary data frame for plotting
      temp_df <- data.frame(x = df[[x_metric_col]],y = df[[y_outcome_col]])
      
      p <- ggplot(data = temp_df,
                  aes(x = x,
                      y = y)) + 
        geom_point() + 
        labs(
          title = paste("Scatter Plot of", y_outcome_col, "vs", x_metric_col),
          y = y_outcome_col,
          x = x_metric_col) +
        theme_minimal()
      print(p)
      p 
      ggsave(file.path(scatter_dir, 
                       paste(x_metric_col, "_vs_", y_outcome_col, ".png")), 
             bg = "white", width= 10, height=10)
      
    }
  }
}
```

## Univariate Mixed Effect Model - video, demographics, MS info

Function - univariate model for each, with REML = False which fits models by optimizing log-likelihood. This allows for later comparison of nested models with anova(). Anova() runs log likelihood test and refits models with REML = False if not done in initial model call. 

```{r}

all_univariate_mixed_effect <- function(data, outcome_column){ 
  # remove hv or zv pattern in column name for consistency 
  colnames(data) <- gsub("pose_zv", "pose", colnames(data))
  colnames(data) <- gsub("pose_hv", "pose", colnames(data))
  
  ################### video metrics ################################
  
  # delta pixel ------------------------------------------------------
  p <- ggplot(data = data, 
              aes(x = delta_pix_h_rel_median_pose, 
                  y = .data[[outcome_column]])) + 
    geom_point()
  print(p)
  
  formula1 <- as.formula(paste(outcome_column, 
                               "~ delta_pix_h_rel_median_pose + (1 | bw_id)"))
  print(formula1)
  uni1 <- lmer(formula1, data = data, REML = FALSE)
  print(summary(uni1))
  
  # Residuals vs. fitted values
  hist(resid(uni1), main = "Residuals delta_pix_h_rel_median_pose")
  
  # Normality check
  qqnorm(residuals(uni1), main = "Normal Q-Q plot: delta_pix_h_rel_median_pose")
  
  # uni df 
  uni1_df <- tidy(uni1, conf.int = TRUE) %>% 
    mutate(R2_conditional = r2(uni1)$R2_conditional) %>% 
    mutate(R2_marginal = r2(uni1)$R2_marginal) %>% 
    mutate(Variable = 'Pixel Height Proxy') %>% 
    mutate(N_observations = nobs(uni1))
  
  # log delta pixel proxy ---------------------------------------------
  p <- ggplot(data = data, 
              aes(x = log_delta_pix_h_rel_median_pose, 
                  y = .data[[outcome_column]])) + 
    geom_point()
  print(p)
  
  formula1_log <- as.formula(paste(outcome_column, 
                               "~ log_delta_pix_h_rel_median_pose + (1 | bw_id)"))
  print(formula1_log)
  uni1_log <- lmer(formula1_log, data = data, REML = FALSE)
  print(summary(uni1_log))
  
  # Residuals vs. fitted values
  hist(resid(uni1_log), main = "Residuals log_delta_pix_h_rel_median_pose")
  
  # Normality check
  qqnorm(residuals(uni1_log), main = "Normal Q-Q plot: log_delta_pix_h_rel_median_pose")
  
  # uni df 
  uni1_log_df <- tidy(uni1_log, conf.int = TRUE) %>% 
    mutate(R2_conditional = r2(uni1_log)$R2_conditional) %>% 
    mutate(R2_marginal = r2(uni1_log)$R2_marginal) %>% 
    mutate(Variable = 'Log Pixel Height Proxy') %>% 
    mutate(N_observations = nobs(uni1_log))
  
  # stride time --------------------------------------------------------------
  print('stride_time_median_sec_pose')
  p <- ggplot(data = data, 
              aes(x = stride_time_median_sec_pose, 
                  y = .data[[outcome_column]])) + 
    geom_point()
  print(p)
  
  formula2 <- as.formula(paste(outcome_column, 
                               "~ stride_time_median_sec_pose + (1 | bw_id)"))
  print(formula2)
  uni2 <- lmer(formula2, data = data, REML = FALSE)
  print(summary(uni2))
  
  # Residuals vs. fitted values
  hist(resid(uni2), main = "Residuals stride_time_median_sec_pose")
  
  # Normality check
  qqnorm(residuals(uni2), main = "Normal Q-Q plot: stride_time_median_sec_pose")
  
  # uni df 
  uni2_df <- tidy(uni2, conf.int = TRUE) %>% 
    mutate(R2_conditional = r2(uni2)$R2_conditional) %>% 
    mutate(R2_marginal = r2(uni2)$R2_marginal) %>% 
    mutate(Variable = 'Stride Time Median')  %>% 
    mutate(N_observations = nobs(uni2))
  
  # cadence -------------------------------------------------------------------
  print('mean_cadence_step_per_min_pose')
  p <- ggplot(data = data, 
              aes(x = mean_cadence_step_per_min_pose, 
                  y = .data[[outcome_column]])) + 
    geom_point()
  print(p)
  
  formula3 <- as.formula(paste(outcome_column, 
                               "~ mean_cadence_step_per_min_pose + (1 | bw_id)"))
  print(formula3)
  uni3 <- lmer(formula3, data = data, REML = FALSE)
  print(summary(uni3))
  
  # Residuals vs. fitted values
  hist(resid(uni3), main = "Residuals mean_cadence_step_per_min_pose")
  
  # Normality check
  qqnorm(residuals(uni3), main = "Normal Q-Q plot: mean_cadence_step_per_min_pose")
  
  # uni df 
  uni3_df <- tidy(uni3, conf.int = TRUE) %>% 
    mutate(R2_conditional = r2(uni3)$R2_conditional) %>% 
    mutate(R2_marginal = r2(uni3)$R2_marginal) %>% 
    mutate(Variable = 'Cadence Mean')  %>% 
    mutate(N_observations = nobs(uni3))
  
  # stride width ----------------------------------------------------------
  print('stride_width_median_cm_pose')
  
  p <- ggplot(data = data, 
              aes(x = stride_width_median_cm_pose, 
                  y = .data[[outcome_column]])) + 
    geom_point()
  print(p)
  
  formula4 <- as.formula(paste(outcome_column, 
                               "~ stride_width_median_cm_pose + (1 | bw_id)"))
  print(formula4)
  uni4 <- lmer(formula4, data = data, REML = FALSE)
  print(summary(uni4))
  
  # Residuals vs. fitted values
  hist(resid(uni4), main = "Residuals stride_width_median_cm_pose")
  
  # Normality check
  qqnorm(residuals(uni4), main = "Normal Q-Q plot: stride_width_median_cm_pose")
  
  # uni df 
  uni4_df <- tidy(uni4, conf.int = TRUE) %>% 
    mutate(R2_conditional = r2(uni4)$R2_conditional) %>% 
    mutate(R2_marginal = r2(uni4)$R2_marginal) %>% 
    mutate(Variable = 'Stride Width Median')  %>% 
    mutate(N_observations = nobs(uni4))
  
  # stance time std  -------------------------------------------
  print('stance_time_per_std_pose')
  
  p <- ggplot(data = data, 
              aes(x = stance_time_sec_std_pose, 
                  y = .data[[outcome_column]])) + 
    geom_point()
  print(p)
  
  formula10 <- as.formula(paste(outcome_column, 
                               "~ stance_time_sec_std_pose + (1 | bw_id)"))
  print(formula10)
  uni10 <- lmer(formula10, data = data, REML = FALSE)
  print(summary(uni10))
  
  # Residuals vs. fitted values
  hist(resid(uni10), main = "Residuals stance_time_sec_std_pose")
  
  # Normality check
  qqnorm(residuals(uni10), main = "Normal Q-Q plot: stance_time_sec_std_pose")
  
  # uni df 
  uni10_df <- tidy(uni10, conf.int = TRUE) %>% 
    mutate(R2_conditional = r2(uni10)$R2_conditional) %>% 
    mutate(R2_marginal = r2(uni10)$R2_marginal) %>% 
    mutate(Variable = 'Stance Time S.D.')  %>% 
    mutate(N_observations = nobs(uni10))
  
  # swing time std -------------------------------------------
  print('swing_time_sec_std_pose')
  
  p <- ggplot(data = data, 
              aes(x = swing_time_sec_std_pose, 
                  y = .data[[outcome_column]])) + 
    geom_point()
  print(p)
  
  formula11 <- as.formula(paste(outcome_column, 
                               "~ swing_time_sec_std_pose + (1 | bw_id)"))
  print(formula11)
  uni11 <- lmer(formula11, data = data, REML = FALSE)
  print(summary(uni11))
  
  # Residuals vs. fitted values
  hist(resid(uni11), main = "Residuals swing_time_sec_std_pose")
  
  # Normality check
  qqnorm(residuals(uni11), main = "Normal Q-Q plot: swing_time_sec_std_pose")
  
  # uni df 
  uni11_df <- tidy(uni11, conf.int = TRUE) %>% 
    mutate(R2_conditional = r2(uni11)$R2_conditional) %>% 
    mutate(R2_marginal = r2(uni11)$R2_marginal) %>% 
    mutate(Variable = 'Swing Time S.D.')  %>% 
    mutate(N_observations = nobs(uni11))
  
   # stance per - median  -------------------------------------------
  print('stance_time_per_mean_pose')
  
  p <- ggplot(data = data, 
              aes(x = stance_time_per_mean_pose, 
                  y = .data[[outcome_column]])) + 
    geom_point()
  print(p)
  
  formula12 <- as.formula(paste(outcome_column, 
                               "~ stance_time_per_mean_pose + (1 | bw_id)"))
  print(formula12)
  uni12 <- lmer(formula12, data = data, REML = FALSE)
  print(summary(uni12))
  
  # Residuals vs. fitted values
  hist(resid(uni12), main = "Residuals stance_time_per_mean_pose")
  
  # Normality check
  qqnorm(residuals(uni12), main = "Normal Q-Q plot: stance_time_per_mean_pose")
  
  # uni df 
  uni12_df <- tidy(uni12, conf.int = TRUE) %>% 
    mutate(R2_conditional = r2(uni12)$R2_conditional) %>% 
    mutate(R2_marginal = r2(uni12)$R2_marginal) %>% 
    mutate(Variable = 'Stance % Mean')  %>% 
    mutate(N_observations = nobs(uni12))
  
  # swing time %-------------------------------------------
  # removed - inverse of stance 
#  print('swing_time_per_mean_pose')
  
#  p <- ggplot(data = data, 
#              aes(x = swing_time_per_mean_pose, 
#                  y = .data[[outcome_column]])) + 
#    geom_point()
#  print(p)
  
#  formula13 <- as.formula(paste(outcome_column, 
#                               "~ swing_time_per_mean_pose + (1 | bw_id)"))
#  print(formula13)
#  uni13 <- lmer(formula13, data = data, REML = FALSE)
#  print(summary(uni13))
  
  # Residuals vs. fitted values
#  hist(resid(uni13), main = "Residuals swing_time_per_mean_pose")
  
  # Normality check
#  qqnorm(residuals(uni13), main = "Normal Q-Q plot: swing_time_per_mean_pose")
  
  # uni df 
#  uni13_df <- tidy(uni13, conf.int = TRUE) %>% 
#    mutate(R2_conditional = r2(uni13)$R2_conditional) %>% 
#    mutate(R2_marginal = r2(uni13)$R2_marginal) %>% 
#    mutate(Variable = 'Swing % Mean')  %>% 
#    mutate(N_observations = nobs(uni13)
  
  # single support time - S.D. -----------------------
  print('singlesupport_time_sec_std_pose')
  
  p <- ggplot(data = data, 
              aes(x = singlesupport_time_sec_std_pose, 
                  y = .data[[outcome_column]])) + 
    geom_point()
  print(p)
  
  formula14 <- as.formula(paste(outcome_column, 
                               "~ singlesupport_time_sec_std_pose + (1 | bw_id)"))
  print(formula14)
  uni14 <- lmer(formula14, data = data, REML = FALSE)
  print(summary(uni14))
  
  # Residuals vs. fitted values
  hist(resid(uni14), main = "Residuals singlesupport_time_sec_std_pose")
  
  # Normality check
  qqnorm(residuals(uni14), main = "Normal Q-Q plot: singlesupport_time_sec_std_pose")
  
  # uni df 
  uni14_df <- tidy(uni14, conf.int = TRUE) %>% 
    mutate(R2_conditional = r2(uni14)$R2_conditional) %>% 
    mutate(R2_marginal = r2(uni14)$R2_marginal) %>% 
    mutate(Variable = 'Single Support Time S.D.')  %>% 
    mutate(N_observations = nobs(uni14))
  
  # double support time - S.D. ------------------------
  print('tot_dsupport_time_sec_std_pose')
  
  p <- ggplot(data = data, 
              aes(x = tot_dsupport_time_sec_std_pose, 
                  y = .data[[outcome_column]])) + 
    geom_point()
  print(p)
  
  formula15 <- as.formula(paste(outcome_column, 
                               "~ tot_dsupport_time_sec_std_pose + (1 | bw_id)"))
  print(formula15)
  uni15 <- lmer(formula15, data = data, REML = FALSE)
  print(summary(uni15))
  
  # Residuals vs. fitted values
  hist(resid(uni15), main = "Residuals tot_dsupport_time_sec_std_pose")
  
  # Normality check
  qqnorm(residuals(uni15), main = "Normal Q-Q plot: tot_dsupport_time_sec_std_pose")
  
  # uni df 
  uni15_df <- tidy(uni15, conf.int = TRUE) %>% 
    mutate(R2_conditional = r2(uni15)$R2_conditional) %>% 
    mutate(R2_marginal = r2(uni15)$R2_marginal) %>% 
    mutate(Variable = 'Double Support Time S.D.')  %>% 
    mutate(N_observations = nobs(uni15))
  
  # single support % - mean --------------------------
  print('singlesupport_per_mean_pose')
  
  p <- ggplot(data = data, 
              aes(x = singlesupport_per_mean_pose, 
                  y = .data[[outcome_column]])) + 
    geom_point()
  print(p)
  
  formula16 <- as.formula(paste(outcome_column, 
                               "~ singlesupport_per_mean_pose + (1 | bw_id)"))
  print(formula16)
  uni16 <- lmer(formula16, data = data, REML = FALSE)
  print(summary(uni16))
  
  # Residuals vs. fitted values
  hist(resid(uni16), main = "Residuals singlesupport_per_mean_pose")
  
  # Normality check
  qqnorm(residuals(uni16), main = "Normal Q-Q plot: singlesupport_per_mean_pose")
  
  # uni df 
  uni16_df <- tidy(uni16, conf.int = TRUE) %>% 
    mutate(R2_conditional = r2(uni16)$R2_conditional) %>% 
    mutate(R2_marginal = r2(uni16)$R2_marginal) %>% 
    mutate(Variable = 'Single Support % Mean')  %>% 
    mutate(N_observations = nobs(uni16))
  
  # double support % - mean ------------------------- 
  print('tot_dsupport_per_mean_pose')
  
  p <- ggplot(data = data, 
              aes(x = tot_dsupport_per_mean_pose, 
                  y = .data[[outcome_column]])) + 
    geom_point()
  print(p)
  
  formula17 <- as.formula(paste(outcome_column, 
                               "~ tot_dsupport_per_mean_pose + (1 | bw_id)"))
  print(formula17)
  uni17 <- lmer(formula17, data = data, REML = FALSE)
  print(summary(uni17))
  
  # Residuals vs. fitted values
  hist(resid(uni17), main = "Residuals tot_dsupport_per_mean_pose")
  
  # Normality check
  qqnorm(residuals(uni17), main = "Normal Q-Q plot: tot_dsupport_per_mean_pose")
  
  # uni df 
  uni17_df <- tidy(uni17, conf.int = TRUE) %>% 
    mutate(R2_conditional = r2(uni17)$R2_conditional) %>% 
    mutate(R2_marginal = r2(uni17)$R2_marginal) %>% 
    mutate(Variable = 'Double Support % Mean')  %>% 
    mutate(N_observations = nobs(uni17))
  
  
  #### demographics and MS info ################## 
  
  # Age ---------------------------------------------
  print('clean_Age')
  
  p <- ggplot(data = data, 
              aes(x = clean_Age, 
                  y = .data[[outcome_column]])) + 
    geom_point()
  print(p)
  
  formula5 <- as.formula(paste(outcome_column, 
                               "~ clean_Age + (1 | bw_id)"))
  print(formula5)
  uni5 <- lmer(formula5, data = data, REML = FALSE)
  print(summary(uni5))
  
  # Residuals vs. fitted values
  hist(resid(uni5), main = "Residuals clean_Age")
  
  # Normality check
  qqnorm(residuals(uni5), main = "Normal Q-Q plot: clean_Age")
  
  # uni df 
  uni5_df <- tidy(uni5, conf.int = TRUE) %>% 
    mutate(R2_conditional = r2(uni5)$R2_conditional) %>% 
    mutate(R2_marginal = r2(uni5)$R2_marginal) %>% 
    mutate(Variable = 'Age')  %>% 
    mutate(N_observations = nobs(uni5))
  
  
  # Disease Duration ---------------------------------------------
  print('demoEHR_DiseaseDuration')
  
  p <- ggplot(data = data, 
              aes(x = demoEHR_DiseaseDuration, 
                  y = .data[[outcome_column]])) + 
    geom_point()
  print(p)
  
  formula6 <- as.formula(paste(outcome_column, 
                               "~ demoEHR_DiseaseDuration + (1 | bw_id)"))
  print(formula6)
  uni6 <- lmer(formula6, data = data, REML = FALSE)
  print(summary(uni6))
  
  # Residuals vs. fitted values
  hist(resid(uni6), main = "Residuals demoEHR_DiseaseDuration")
  
  # Normality check
  qqnorm(residuals(uni6), main = "Normal Q-Q plot: demoEHR_DiseaseDuration")
  
  # uni df 
  uni6_df <- tidy(uni6, conf.int = TRUE) %>% 
    mutate(R2_conditional = r2(uni6)$R2_conditional) %>% 
    mutate(R2_marginal = r2(uni6)$R2_marginal) %>% 
    mutate(Variable = 'Disease Duration')  %>% 
    mutate(N_observations = nobs(uni6))
  
  # MS DX ---------------------------------------------
  print('ms_dx_condensed')
  
  formula7 <- as.formula(paste(outcome_column, 
                               "~ ms_dx_condensed + (1 | bw_id)"))
  print(formula7)
  uni7 <- lmer(formula7, data = data, REML = FALSE)
  print(summary(uni7))
  
  # Residuals vs. fitted values
  hist(resid(uni7), main = "Residuals ms_dx_condensed")
  
  # Normality check
  qqnorm(residuals(uni7), main = "Normal Q-Q plot: ms_dx_condensed")
  
  # uni df 
  uni7_df <- tidy(uni7, conf.int = TRUE) %>% 
    mutate(R2_conditional = r2(uni7)$R2_conditional) %>% 
    mutate(R2_marginal = r2(uni7)$R2_marginal) %>% 
    mutate(Variable = 'MS DX')  %>% 
    mutate(N_observations = nobs(uni7))
  
  
  # tidy and bind all together --------------------------------
  tidy_uni_df <- bind_rows(uni5_df, uni6_df, uni7_df, 
                           uni1_df, uni1_log_df, uni2_df, uni3_df, uni4_df, 
                           uni10_df, uni11_df, uni12_df, 
                           uni14_df, uni15_df, uni16_df,
                           uni17_df) %>% 
    mutate(Model = "Univariate Unadjusted") 
  
  return(tidy_uni_df)
}

```

## Round p-values for plotting 
```{r}
# Conditional rounding function
format_p_value <- function(p) {
  if (p < 0.001) {
    return("<0.001")  # Scientific notation, 1 decimal place
  } else {
    return(formatC(p, format = "f", digits = 3))  # Standard notation, 2 decimal places
  }
}
```

## Format dataframes for tables 

```{r}
format_p_value_tables <- function(df){
  
  df <- df %>% 
    mutate(formatted_pval = ifelse(p.value < 0.001, '<0.001', round(p.value, 3)))
  
  return(df)
  
}
```

```{r}
format_tables <- function(df){
  
  df <- format_p_value_tables(df)
  
  df <- df %>% 
    mutate(across(c('std.error', 'statistic','R2_conditional', 'R2_marginal'), \(x) round(x, digits = 2))) %>%
    mutate(across(c('estimate', 'conf.low', 'conf.high'), \(x) signif(x, digits = 2))) 
  
  df$conf_int <- paste0("[", df$conf.low, ", ", df$conf.high, "]")
  
  return(df)
}
```

## Set variable order plots 
```{r}
factor_term <- function(df){
  
  # remove hv or zv pattern in names for consistency
  df$term <- gsub("pose_zv", "pose", df$term)
  df$term <- gsub("pose_hv", "pose", df$term)
  
  
  df$term_factor <- factor(df$term, 
                                levels = c("clean_Age", 
                                           "demoEHR_DiseaseDuration", 
                                           "ms_dx_condensedProgressive MS",
                                           "ms_dx_condensedMS, Subtype Not Specified", 
                                           "delta_pix_h_rel_median_pose",
                                           "log_delta_pix_h_rel_median_pose", 
                                           "stride_time_median_sec_pose",
                                           "mean_cadence_step_per_min_pose",
                                           "stride_width_median_cm_pose", 
                                           "stance_time_sec_std_pose", 
                                           "swing_time_sec_std_pose", 
                                            "stance_time_per_mean_pose", 
                                           "swing_time_per_mean_pose", 
                                           "singlesupport_time_sec_std_pose", 
                                           "tot_dsupport_time_sec_std_pose", 
                                           "singlesupport_per_mean_pose", 
                                           "tot_dsupport_per_mean_pose"), 
                                labels = c("Age", 
                                           'Disease Duration', 
                                           "MS DX: Progressive MS",
                                           "MS DX: Not Specififed", 
                                           "Pixel Proxy Median",
                                           "Log Pixel Proxy Median",
                                           "Stride Time Median", 
                                           "Cadence Mean", 
                                           "Stride Width Median", 
                                           "Stance Time S.D.", 
                                           "Swing Time S.D.", 
                                           "Stance % Mean", 
                                           "Swing % Mean", 
                                           "Single Support Time S.D.", 
                                           "Double Support Time S.D.", 
                                           "Single Support % Mean", 
                                           "Double Support % Mean"
                                           ))
  
  df$term_factor <- factor(df$term_factor, levels = rev(levels(df$term_factor)))
  
  
  return(df)

}
```


##  Plot univariate regression estimates 
Should work for univariate or multivariate models - plot each variable as diff color 
Significance based transparency 

```{r}
univariate_regression_plot <- function(results, plot_title, x_adj) {
  
  # Filter rows and add type column for colors 
  results <- results %>% 
    filter(effect != 'ran_pars') %>% 
    filter(term != '(Intercept)') %>% 
    mutate(Type = ifelse(grepl('pose', term), 'Video Metrics', 'Demographics')) 
  
  results$Variable <- factor(results$Variable)
  results$Type <- factor(results$Type, c(levels = 'Demographics', 'Video Metrics'))
  
  # Apply rounding function to p-value columns 
  results <- results %>% mutate(pval_text = paste0("p=", sapply(p.value, format_p_value)))  # Format p-values
  
  # Apply formatting function and create significance indicators
  results <- results %>%
    mutate(
      pval_text = paste0("p=", sapply(p.value, format_p_value)),
      sig = ifelse(p.value < 0.05, "Significant", "Non-Significant"),  # Create significance group
      alpha_level = ifelse(p.value < 0.05, 1, 0.3)  # More transparency for non-sig points
    )
  
  # set colors 
  model_colors <- c("Demographics" = "#E69F00",
                    "Video Metrics" = "#0072B2")
  
  # Determine x position for p-values (offset to the right of the max estimate)
  x_max <- max(results$conf.high, na.rm = TRUE)  # Get max confidence interval upper bound
  results <- results %>% mutate(pval_x_pos = x_max + x_adj)  # Place p-values slightly to the right of max x range
  
  p <- ggplot(results, aes(x = estimate, y = term_factor, color = Type, alpha = alpha_level))+ 
    geom_point(size = 2)  + # dot = coefficient estimate 
    geom_errorbarh(aes(xmin = conf.low, xmax = conf.high), height = 0.2) +  # Whiskers for confidence intervals
    geom_text(aes(x = pval_x_pos, label = pval_text, fontface = ifelse(p.value < 0.05, "bold", "plain")), 
              hjust = 1, size = 2) +  # Right-aligned p-values, bold if significant
    scale_color_manual(values = model_colors) +  # Set custom colors for models
    scale_alpha_identity() +  # Use manually set alpha levels
    geom_vline(xintercept = 0, linetype = "dashed", color = "gray50") +  # Reference line at zero
    theme_minimal() + 
    labs(title = plot_title,
         x = "Estimate (Effect Size)",
         y = "Predictor") +
    theme(legend.position = "right",  
          plot.title = element_text(size = 11, face = 'bold', hjust = 0.5),
          axis.title = element_text(size = 11),
          #axis.text = element_text(size = 9),
          axis.text.y = element_text(size = 9),
          axis.text.x = element_text(size = 9),
          legend.text = element_text(size = 9),
          legend.title = element_blank()
          )  
  
  return(p)
}
```

## Plot Adjusted vs Unadjusted Coefficient estimates 
```{r}
adj_vs_unadj_plot <- function(results_df, plot_title, x_adj){
  
  set.seed(42)  # Set seed for reproducibility
  
  # Filter rows 
  results_df <- results_df %>% 
    filter(effect != 'ran_pars') %>% 
    filter(term != '(Intercept)') %>%
    mutate(term = gsub("pose_zv", "pose", term)) %>% 
    mutate(term = gsub("pose_hv", "pose", term)) %>%
    factor_term() # function above - format variable order for plots 
  
  results_df <- results_df %>%
    mutate(
      pval_text = paste0("p=", sapply(p.value, format_p_value)),  # Format p-values
      sig = ifelse(is.na(p.value) | p.value >= 0.05, "Non-Significant", "Significant"),  # Identify significance
      alpha_level = ifelse(is.na(p.value) | p.value >= 0.05, 0.3, 1),  # More transparency for non-sig points
      jitter_y = as.numeric(factor(term_factor)) + runif(n(), -0.2, 0.2)  # Jitter y-axis values slightly
    )
  
  
  
  # Define colors for models
  model_colors <- c("Model 1" = "#E69F00",
                    "Model 2" = "#0072B2", 
                    "Model 3"= "black", 
                    "Model 4" = "#CC79A7") 
  
  # Define shading by creating an index for each predictor group
  results_df <- results_df %>%
    arrange(term_factor) %>%
    mutate(group = as.integer(factor(term_factor)) %% 2)  # Alternating shading
  
  
  # Determine x position for p-values (offset to the right of max estimate)
  x_max <- max(results_df$conf.high, na.rm = TRUE)  # Get max confidence interval upper bound
  results_df <- results_df %>%
    mutate(pval_x_pos = x_max + x_adj)  # Place p-values slightly to the right of max x range
  
  # Dot-and-whisker plot with enhancements
  p <- ggplot(results_df, aes(x = estimate, y = term_factor, color = Model, alpha = alpha_level)) +
    # Add confidence intervals as horizontal whiskers
    geom_errorbarh(aes(xmin = conf.low, xmax = conf.high), height = 0.2, 
                   position = position_dodge(width = 0.75)) + 
    # Add dots for coefficient estimates
    geom_point(position = position_dodge(width = 0.75), size = 1.25) + 
    # Add background shading for alternate rows
    geom_rect(data = results_df, aes(ymin = as.numeric(factor(term_factor)) - 0.5, 
                                     ymax = as.numeric(factor(term_factor)) + 0.5,
                                     xmin = -Inf, xmax = Inf, 
                                     fill = factor(group)),
              inherit.aes = FALSE, alpha = 0.1) +
    # Add vertical line at zero (null effect)
    geom_vline(xintercept = 0, linetype = "dashed", color = "gray50", alpha = 0.3) + 
    # Add jittered p-values at right side
    geom_text(aes(x = pval_x_pos, y = jitter_y, label = pval_text, 
                  fontface = ifelse(sig == "Significant", "bold", "plain")),
              hjust = 1, size = 2.5) + 
    scale_color_manual(values = model_colors) +  # Set custom colors for models
    scale_fill_manual(values = c("white", "gray90")) +  # Alternating shading
    scale_alpha_identity() +  # Use manually set alpha levels
    theme_minimal() +
    labs(title = plot_title,
         x = "Estimate (Effect Size)",
         y = "Predictor",
         color = "Model") +  
    theme(legend.position = "right",  # Move legend to the right
          panel.grid.major = element_blank(),  # Remove major grid lines for clarity
          panel.grid.minor = element_blank(),
          plot.title = element_text(size = 11, face = 'bold', hjust = 0.5),
          axis.title = element_text(size = 11),
          #axis.text = element_text(size = 9),
          axis.text.y = element_text(size = 9),
          axis.text.x = element_text(size = 9),
          legend.text = element_text(size = 9),
          legend.title = element_text(size = 9)
          )
  
  return(p)
  
} 
```

## Run and save univariate model results 
```{r}
run_save_univariate <- function(df, outcome_column_str, data_name_string, plot_x_adj){
  
  uni_results_all <- all_univariate_mixed_effect(data = df,
                                                 outcome_column = outcome_column_str) %>% 
    format_tables() %>% 
    mutate(Outcome = outcome_column_str) %>% 
    factor_term() # function above - format variable order for plots 
  
  print(head(uni_results_all))
  
  write.csv(uni_results_all, file.path(output_dir, 
                                       outcome_column_str,
                                       paste(outcome_column_str, 
                                             '_univariate_', 
                                             data_name_string, 
                                             '_results.csv', sep = '')))
  
  # save adjusted r_squared 
  adj_r_squared_df <- uni_results_all[c('Variable', 'R2_conditional', 'R2_marginal')] %>% 
    distinct()  # remove duplicates 
  print(adj_r_squared_df)
  write.csv(adj_r_squared_df, file.path(output_dir,
                                        outcome_column_str,
                                        paste(outcome_column_str, 
                                              '_univariate_',
                                              data_name_string,
                                              '_r2.csv', sep = '')))
  
  # Plot estimates 
  if (outcome_column_str == 't25fw_log'){
    outcome_title = 'Log T25FW'
  } else if (outcome_column_str == "clean_T25FW_Avg") {
    outcome_title = 'T25FW'
  } else if (outcome_column_str == "t25fw_sqrt") {
    outcome_title = 'Square Root T25FW'
  } else if (outcome_column_str == 'PWS_velocitycmsecmean') {
    outcome_title = 'Zeno PWS Velocity'
  } else if (outcome_column_str == 'FW_velocitycmsecmean'){
    outcome_title = 'Zeno FW Velocity'
  } else {
    outcome_title = outcome_column_str
  }
  
  plot_title <- paste(data_name_string, " Univariate Models\nlmer(", 
                      outcome_title, 
                      " ~ Predictor + (1 | ID))", sep = '')
  
  p <- univariate_regression_plot(results = uni_results_all, 
                                  plot_title = plot_title, 
                                  x_adj = plot_x_adj)
  print(p)
  p 
  ggsave(file.path(output_dir, 
                   outcome_column_str, 
                   paste(outcome_column_str, 
                         '_univariate_',
                         data_name_string,
                         '_estimates.png', sep = '')), 
         bg = "white", width= 6.5, height=4)
  
  
}
```

## Run and save multivariate results 
Function - univariate model for each, with REML = False which fits models by optimizing log-likelihood. This allows for later comparison of nested models with anova(). Anova() runs log likelihood test and refits models with REML = False if not done in initial model call. 
```{r}
multivariate_save_results <- function(formula, df, outcome_column_str, model_str, output_dir){
  
  multivar_results <- lmer(formula, data = df, REML = FALSE)
  
  # Residuals vs. fitted values
  fitted_vals <- fitted(multivar_results)
  resid_vals <- resid(multivar_results)

  resid_df <- data.frame(Fitted = fitted_vals, Residuals = resid_vals)

  p <- ggplot(resid_df, aes(x = Fitted, y = Residuals)) +
    geom_point(alpha = 0.6) +
    geom_hline(yintercept = 0, linetype = "dashed", color = "grey") +
    labs(
      title = paste("Fitted vs Residuals:", model_str),
      x = "Fitted Values",
      y = "Residuals"
    ) +
    theme_minimal()
  print(p)
  p
  # ggsave()
  
  # Normality 
  qqnorm(residuals(multivar_results), main = paste("Normal Q-Q plot:", model_str, sep = " "))
  hist(resid(multivar_results), main = paste("Residuals:", model_str, sep = " "))
  
  # tidy results
  multivar_results_df <- tidy(multivar_results, conf.int = TRUE) %>% 
    mutate(R2_conditional = r2(multivar_results)$R2_conditional) %>% 
    mutate(R2_marginal = r2(multivar_results)$R2_marginal) %>% 
    mutate(Model = model_str) %>%
    mutate(Outcome = outcome_column_str)  %>% 
    mutate(N_observations = nobs(multivar_results))
  
  return(list(df = multivar_results_df, object = multivar_results))
}
```

## Bind and plot all multivar results  
```{r}
bind_plot_multivar_results <- function(multi_dem_df, multi_vid_unadj_df, multi_vid_adj_df,
                                       outcome_column_str, dataset_name, plot_x_adj) {
  
  multivar_all <- bind_rows(multi_dem_df, 
                            multi_vid_unadj_df, 
                            multi_vid_adj_df) %>% 
    format_tables() %>% 
    factor_term() # function above - format variable order for plots 
  
  print(head(multivar_all))
  
  write.csv(multivar_all, file.path(output_dir, 
                                    outcome_column_str,
                                    paste(outcome_column_str, 
                                          '_adj_vs_unadj_',
                                          dataset_name,
                                          '_results.csv', sep= '')))
  
  # save R-squared 
  adj_r_squared_df <- multivar_all[c('Model', 'R2_conditional', 'R2_marginal')] %>% 
    distinct()  
  print(adj_r_squared_df)
  write.csv(adj_r_squared_df, file.path(output_dir, 
                                        outcome_column_str,
                                        paste(outcome_column_str, 
                                              '_adj_vs_unadj_',
                                              dataset_name,
                                              '_r2.csv', sep = '')))
  
  # plot and save plot 
  if (outcome_column_str == 't25fw_log'){
    outcome_title = 'Log T25FW'
  } else if (outcome_column_str == "clean_T25FW_Avg") {
    outcome_title = 'T25FW'
  } else if (outcome_column_str == "t25fw_sqrt") {
    outcome_title = 'Square Root T25FW'
  } else if (outcome_column_str == 'PWS_velocitycmsecmean') {
    outcome_title = 'Zeno PWS Velocity'
  } else if (outcome_column_str == 'FW_velocitycmsecmean'){
    outcome_title = 'Zeno FW Velocity'
  } else {
    outcome_title = outcome_column_str
  }
  
  title <- paste(dataset_name, " Multivariate Models\nlmer(", 
                      outcome_title, 
                      " ~ Predictors + (1 | ID))", sep = '')
  
  p <- adj_vs_unadj_plot(results_df = multivar_all, 
                         plot_title = title, 
                         x_adj = plot_x_adj)
  print(p)
  p
  ggsave(file.path(output_dir, 
                   outcome_column_str, 
                   paste(outcome_column_str, '_adj_vs_unadj_',
                         dataset_name,
                         '_estimates.png', sep = '')),
         bg = "white", width= 6.5, height= 4.5)
  
  return(multivar_all)
}
```

# T25FW Mixed Effect Model 

## Check all Date Diff <+- 365 days 

```{r}
# PWS 
p1 <- ggplot(data = zeno_pws_df, aes(msfcEHR_T25FW.SPEED.TRIAL.1.vDate.Diff)) + 
  geom_histogram()
p1

# FW 
p2 <- ggplot(data = zeno_fw_df, aes(msfcEHR_T25FW.SPEED.TRIAL.1.vDate.Diff)) + 
  geom_histogram()
p2

# home 
p3 <- ggplot(data = home_df, aes(msfcEHR_T25FW.SPEED.TRIAL.1.vDate.Diff)) + 
  geom_histogram()
p3
```


## Plot and transform T25FW 
```{r}
# preferred walking speed 
ggplot(data = zeno_pws_df, mapping = aes(clean_T25FW_Avg)) + 
  geom_histogram()

# log transform 
zeno_pws_df$t25fw_log <- log(zeno_pws_df$clean_T25FW_Avg)
ggplot(data = zeno_pws_df, mapping = aes(t25fw_log)) + 
  geom_histogram()

# inverse transformation 
zeno_pws_df$t25fw_inverse <- 1/zeno_pws_df$clean_T25FW_Avg
ggplot(data = zeno_pws_df, mapping = aes(t25fw_inverse)) + 
  geom_histogram()

# square root  
zeno_pws_df$t25fw_sqrt <- sqrt(zeno_pws_df$clean_T25FW_Avg) 
ggplot(data = zeno_pws_df, mapping = aes(t25fw_sqrt)) + 
  geom_histogram()
```

```{r}
# Fast walking speed 
ggplot(data = zeno_fw_df, mapping = aes(clean_T25FW_Avg)) + 
  geom_histogram()

# log transform 
zeno_fw_df$t25fw_log <- log(zeno_fw_df$clean_T25FW_Avg) 
ggplot(data = zeno_fw_df, mapping = aes(t25fw_log)) + 
  geom_histogram()

# inverse transformation 
zeno_fw_df$t25fw_inverse <- 1/zeno_fw_df$clean_T25FW_Avg
ggplot(data = zeno_fw_df, mapping = aes(t25fw_inverse)) + 
  geom_histogram()

# square root  
zeno_fw_df$t25fw_sqrt <- sqrt(zeno_fw_df$clean_T25FW_Avg) 
ggplot(data = zeno_fw_df, mapping = aes(t25fw_sqrt)) + 
  geom_histogram()

```

```{r}
# Home Videos 
ggplot(data = home_df, mapping = aes(clean_T25FW_Avg)) + 
  geom_histogram()

# log transform 
home_df$t25fw_log <- log(home_df$clean_T25FW_Avg) 
ggplot(data = home_df, mapping = aes(t25fw_log)) + 
  geom_histogram()

# inverse transformation 
home_df$t25fw_inverse <- 1/home_df$clean_T25FW_Avg
ggplot(data = home_df, mapping = aes(t25fw_inverse)) + 
  geom_histogram()

# square root  
home_df$t25fw_sqrt <- sqrt(home_df$clean_T25FW_Avg) 
ggplot(data = home_df, mapping = aes(t25fw_sqrt)) + 
  geom_histogram()
```
## Make output folder for each T25FW outcome 

```{r}

clean_t25fw_dir <- file.path(output_dir, "clean_T25FW_Avg")
if (file.exists(clean_t25fw_dir) == FALSE){
  dir.create(clean_t25fw_dir)
}

t25fw_log_dir <- file.path(output_dir, "t25fw_log")
# create output folder if it doesn't already exist 
if (file.exists(t25fw_log_dir) == FALSE){
  dir.create(t25fw_log_dir)
}

t25fw_inverse_dir <- file.path(output_dir, "t25fw_inverse")
# create output folder if it doesn't already exist 
if (file.exists(t25fw_inverse_dir) == FALSE){
  dir.create(t25fw_inverse_dir)
}

t25fw_sqrt_dir <- file.path(output_dir, "t25fw_sqrt")
# create output folder if it doesn't already exist 
if (file.exists(t25fw_sqrt_dir) == FALSE){
  dir.create(t25fw_sqrt_dir)
}

```

## Transform Velocity Proxy 
log transform to improve linearity and replace inf values with NA 
```{r}
zeno_pws_df$log_delta_pix_h_rel_median_pose_zv <- log(zeno_pws_df$delta_pix_h_rel_median_pose_zv)
zeno_fw_df$log_delta_pix_h_rel_median_pose_zv <- log(zeno_fw_df$delta_pix_h_rel_median_pose_zv)
home_df$log_delta_pix_h_rel_median_pose_hv <- log(home_df$delta_pix_h_rel_median_pose_hv)

# convert inf to NaN 
zeno_pws_df[] <- lapply(zeno_pws_df, function(x) {
  if (is.numeric(x)) replace(x, is.infinite(x), NA) else x
})

zeno_fw_df[] <- lapply(zeno_fw_df, function(x) {
  if (is.numeric(x)) replace(x, is.infinite(x), NA) else x
})

home_df[] <- lapply(home_df, function(x) {
  if (is.numeric(x)) replace(x, is.infinite(x), NA) else x
})
```


## Preferred walking speed videos 
### Check outcome transforms and select metrics 
```{r}
y_outcome_cols <- c("clean_T25FW_Avg", "t25fw_log", "t25fw_inverse", "t25fw_sqrt") 
#plot_outcome_transforms_vs_predictors(zeno_pws_df, y_outcome_cols, 'pws', output_dir)
```

### Set outcome variable 
```{r}
pws_t25fw_outcome_col = "t25fw_log"
```

### Drop rows with any missing video metrics 
Not all metrics could be calculated from each video metric 

Dropped videos missing any video metric so models could be compared 
```{r}
zeno_pws_clean_df <- zeno_pws_df %>% 
  drop_na(c("stride_time_median_sec_pose_zv", 
            "log_delta_pix_h_rel_median_pose_zv",
            "mean_cadence_step_per_min_pose_zv",
            "stride_width_median_cm_pose_zv"))

print(nrow(zeno_pws_clean_df))
```



### Univariate Models 
```{r}
run_save_univariate(zeno_pws_df, pws_t25fw_outcome_col, 'PWS', plot_x_adj = 0.5)
```

### Multivariate MS Info and Demographics

```{r}
 
t25fw_pws_multi_dem_formula <- as.formula(paste(pws_t25fw_outcome_col, 
                                         "~ clean_Age +
                                         demoEHR_DiseaseDuration +
                                        ms_dx_condensed +
                                       (1|bw_id)"))

t25fw_pws_multi_dem_results <- multivariate_save_results(formula = t25fw_pws_multi_dem_formula,
                                               df = zeno_pws_clean_df,
                                               outcome_column_str = pws_t25fw_outcome_col,
                                               model_str = "Model 1")

t25fw_pws_multi_dem_results$df
summary(t25fw_pws_multi_dem_results$object)
```
### Multivariate Unadj Videos 
```{r}
t25fw_pws_multi_metrics_formula <- as.formula(paste(pws_t25fw_outcome_col, "~ stride_time_median_sec_pose_zv +
                                                      log_delta_pix_h_rel_median_pose_zv + 
                                                    #  mean_cadence_step_per_min_pose_zv + 
                                                      stride_width_median_cm_pose_zv +
                                                      (1|bw_id)"))
t25fw_pws_multi_metrics_formula

t25fw_pws_multi_metrics_results <- multivariate_save_results(formula = t25fw_pws_multi_metrics_formula,
                                               df = zeno_pws_clean_df,
                                               outcome_column_str = pws_t25fw_outcome_col,
                                               model_str = "Model 2") 
t25fw_pws_multi_metrics_results$df
summary(t25fw_pws_multi_metrics_results$object)
```

### Multivariate Adj Videos + MS Info + Dem

```{r}
# adjusted: Metrics and MS Info 

t25fw_pws_multi_vid_adj_formula <- as.formula(paste(pws_t25fw_outcome_col, 
                                                      "~ stride_time_median_sec_pose_zv +
                                                      log_delta_pix_h_rel_median_pose_zv + 
                                                    #  mean_cadence_step_per_min_pose_zv + 
                                                      stride_width_median_cm_pose_zv + 
                                                      clean_Age +
                                                      demoEHR_DiseaseDuration + 
                                                      ms_dx_condensed +
                                                      (1|bw_id)"))
t25fw_pws_multi_vid_adj_formula


t25fw_pws_multi_vid_adj_results <- multivariate_save_results(formula = t25fw_pws_multi_vid_adj_formula,
                                               df = zeno_pws_clean_df,
                                               outcome_column_str = pws_t25fw_outcome_col,
                                               model_str = "Model 3") 
t25fw_pws_multi_vid_adj_results$df
summary(t25fw_pws_multi_vid_adj_results$object)

```


### ANOVA - Compare Multivar Models 
p value < 0.05, more complex model is significantly better than the simpler model 

https://bookdown.org/ndphillips/YaRrr/comparing-regression-models-with-anova.html 
```{r}
# Demographics only vs Video + Demographics 
aov_1 <- anova(t25fw_pws_multi_dem_results$object, t25fw_pws_multi_vid_adj_results$object)
aov_1_df <- as.data.frame(aov_1)

# Video only vs Video + Demographics 
aov_2 <- anova(t25fw_pws_multi_metrics_results$object, t25fw_pws_multi_vid_adj_results$object)
aov_2_df <- as.data.frame(aov_2)


```

### Save Multivariate results 
```{r}
bind_plot_multivar_results(t25fw_pws_multi_dem_results$df,
                           t25fw_pws_multi_metrics_results$df,
                           t25fw_pws_multi_vid_adj_results$df, 
                           pws_t25fw_outcome_col, 
                           'PWS',
                           plot_x_adj = 2)
```


## Fast Walking Speed Videos 

### Check outcome transforms 
```{r}
y_outcome_cols <- c("clean_T25FW_Avg", "t25fw_log", "t25fw_inverse", "t25fw_sqrt") 
#plot_outcome_transforms_vs_predictors(zeno_fw_df, y_outcome_cols, 'FW', output_dir)
# log? 
```

### Set Outcome variable 
```{r}
fw_t25fw_outcome_col = pws_t25fw_outcome_col
```

### Drop rows with any missing video metrics 
Not all metrics could be calculated from each video metric 

Dropped videos missing any video metric so models could be compared 
```{r}
zeno_fw_clean_df <- zeno_fw_df %>% 
  drop_na(c("stride_time_median_sec_pose_zv", 
            "log_delta_pix_h_rel_median_pose_zv",
            "mean_cadence_step_per_min_pose_zv",
            "stride_width_median_cm_pose_zv"
            ))

nrow(zeno_fw_df)
nrow(zeno_fw_clean_df)
```

### Univariate Models 
```{r}
run_save_univariate(zeno_fw_df, fw_t25fw_outcome_col, 'FW', plot_x_adj = 0.5)
```


### Model 1 - Multivariate Demographics and MS Info 
```{r}
t25fw_fw_multi_dem_formula <- as.formula(paste(fw_t25fw_outcome_col, 
                                         "~ clean_Age +
                                         demoEHR_DiseaseDuration +
                                         ms_dx_condensed +
                                       (1|bw_id)"))

t25fw_fw_multi_dem_results <- multivariate_save_results(formula = t25fw_fw_multi_dem_formula,
                                               df = zeno_fw_clean_df,
                                               outcome_column_str = fw_t25fw_outcome_col,
                                               model_str = "Model 1")

t25fw_fw_multi_dem_results$df
summary(t25fw_fw_multi_dem_results$object)
performance(t25fw_fw_multi_dem_results$object)
```


### Model 2 - Multivariate Video Models - Unadjusted 
 
```{r}
t25fw_fw_multi_metrics_formula <- as.formula(paste(fw_t25fw_outcome_col, "~ 
                                                      log_delta_pix_h_rel_median_pose_zv +
                                                      stride_time_median_sec_pose_zv +
                                                    #  mean_cadence_step_per_min_pose_zv + 
                                                      stride_width_median_cm_pose_zv +
                                                      (1|bw_id)"))
t25fw_fw_multi_metrics_formula

t25fw_fw_multi_metrics_results <- multivariate_save_results(formula = t25fw_fw_multi_metrics_formula,
                                               df = zeno_fw_clean_df,
                                               outcome_column_str = fw_t25fw_outcome_col,
                                               model_str = "Model 2") 
t25fw_fw_multi_metrics_results$df
summary(t25fw_fw_multi_metrics_results$object)
performance(t25fw_fw_multi_metrics_results$object)
```


### Model 3 - Multivariate Video Models - Adjusted  
```{r}
# adjusted: Metrics and MS Info 

t25fw_fw_multi_vid_adj_formula <- as.formula(paste(fw_t25fw_outcome_col, "~ clean_Age +
                                                      demoEHR_DiseaseDuration + 
                                                      ms_dx_condensed + 
                                                      log_delta_pix_h_rel_median_pose_zv +
                                                      stride_time_median_sec_pose_zv +
                                                  #    mean_cadence_step_per_min_pose_zv + 
                                                      stride_width_median_cm_pose_zv +
                                                      (1|bw_id)"))
t25fw_fw_multi_vid_adj_formula


t25fw_fw_multi_vid_adj_results <- multivariate_save_results(formula = t25fw_fw_multi_vid_adj_formula,
                                               df = zeno_fw_clean_df,
                                               outcome_column_str = fw_t25fw_outcome_col,
                                               model_str = "Model 3") 
t25fw_fw_multi_vid_adj_results$df
summary(t25fw_fw_multi_vid_adj_results$object)
performance(t25fw_fw_multi_vid_adj_results$object)
```


### Model 4 - Simple Adjusted - with sig predictors from model 3 adjusted  
```{r}
t25fw_fw_multi_simple <- as.formula(paste(fw_t25fw_outcome_col, "~ clean_Age +
                                                      log_delta_pix_h_rel_median_pose_zv +
                                                      stride_time_median_sec_pose_zv +
                                                      (1|bw_id)"))
t25fw_fw_multi_simple


t25fw_fw_multi_simple_results <- multivariate_save_results(formula = t25fw_fw_multi_simple,
                                               df = zeno_fw_clean_df,
                                               outcome_column_str = fw_t25fw_outcome_col,
                                               model_str = "Model 4") 
t25fw_fw_multi_simple_results$df
summary(t25fw_fw_multi_simple_results$object)
adj_vs_unadj_plot(t25fw_fw_multi_simple_results$df, 'Model 4', 1.5)
performance(t25fw_fw_multi_simple_results$object)
```
### ANOVA - Compare Multivar Models 
p value < 0.05, more complex model is significantly better than the simpler model 
https://bookdown.org/ndphillips/YaRrr/comparing-regression-models-with-anova.html 

Demographics only vs Video + Demographics 
If p <0.05, adding videos to demographic model is significantly better fit than demographics alone 
```{r}
anova_1_3 <- anova(t25fw_fw_multi_dem_results$object, t25fw_fw_multi_vid_adj_results$object)
print(anova_1_3)
anova_1_3_df <- as.data.frame(anova_1_3) 
  
anova_1_3_df$p_formatted <- ifelse(anova_1_3_df$`Pr(>Chisq)` < 0.001, '<0.001', round(anova_1_3_df$`Pr(>Chisq)`, 3))
anova_1_3_df$Model <- c('Model 1', 'Model 3') 
anova_1_3_df$Models <- c('Model 1 and 3') 
anova_1_3_df$Chisq <- round(anova_1_3_df$Chisq, 2)
anova_1_3_df

```

Video only vs Video + Demographics 
If p <0.05, adding demographics to video model is better fit than video metrics alone 
```{r}
anova_2_3 <- anova(t25fw_fw_multi_metrics_results$object, t25fw_fw_multi_vid_adj_results$object)
print(anova_2_3)

anova_2_3_df <- as.data.frame(anova_2_3) 
  
anova_2_3_df$p_formatted <- ifelse(anova_2_3_df$`Pr(>Chisq)` < 0.001, '<0.001', round(anova_2_3_df$`Pr(>Chisq)`, 3))
anova_2_3_df$Model <- c('Model 2', 'Model 3') 
anova_2_3_df$Models <- c('Model 2 and 3') 
anova_2_3_df$Chisq <- round(anova_2_3_df$Chisq, 2)
anova_2_3_df
```

Simpler adjusted vs video + demographics 
If p <0.05, model 3 with all predictors significantly better fit than simpler model 4 with just age, pixel proxy, and stride time
```{r}
anova_4_3 <- anova(t25fw_fw_multi_simple_results$object, t25fw_fw_multi_vid_adj_results$object)
print(anova_4_3)

anova_4_3_df <- as.data.frame(anova_4_3) 
  
anova_4_3_df$p_formatted <- ifelse(anova_4_3_df$`Pr(>Chisq)` < 0.001, '<0.001', round(anova_4_3_df$`Pr(>Chisq)`, 3))
anova_4_3_df$Model <- c('Model 4', 'Model 3') 
anova_4_3_df$Models <- c('Model 4 and 3') 
anova_4_3_df$Chisq <- round(anova_4_3_df$Chisq, 2)
anova_4_3_df
```
save all anova results 
```{r}
anova_all_df <- bind_rows(anova_1_3_df %>% mutate(p_formatted = as.character(p_formatted)), 
                          anova_2_3_df  %>% mutate(p_formatted = as.character(p_formatted)), 
                          anova_4_3_df %>% mutate(p_formatted = as.character(p_formatted))
                          ) %>% 
  mutate(logLik = round(logLik, 2)) %>% 
  mutate(Chisq = round(Chisq, 2))

anova_all_df

write.csv(anova_all_df, 
          file.path(output_dir, 
                    fw_t25fw_outcome_col, 
                    't25fw_log_FW_log_likelihood_tests.csv'))
```

### Save All Multivar results 
```{r}
# function takes 3 variables - merge last two before plotting
temp_df <- bind_rows(t25fw_fw_multi_vid_adj_results$df, t25fw_fw_multi_simple_results$df)

bind_plot_multivar_results(t25fw_fw_multi_dem_results$df,
                           t25fw_fw_multi_metrics_results$df,
                           temp_df, 
                           fw_t25fw_outcome_col, 
                           'FW',
                           plot_x_adj = 0.5)
```

# Plot from simpler model

Observed Vs Predicted 
```{r}
predicted <- predict(t25fw_fw_multi_simple_results$object)
df <- data.frame(Observed = zeno_fw_clean_df$t25fw_log,
	                 Predicted = predicted)

p1 <- ggplot(df, aes(x = Observed, y = Predicted)) +
	 geom_point(size = 0.75, alpha = 0.6) +
	 geom_abline(intercept = 3, slope = 1,
	             linetype = "dashed") + 
  coord_fixed(ratio = 1) + 
  labs(title='Model 4: Observed vs Predicted',
        x ="Observed Log T25FW", y = "Predicted Log T25FW") + 
  theme_minimal() + 
  theme(plot.title = element_text(size = 9, face = 'bold', hjust = 0.5),
          axis.title = element_text(size = 9),
          #axis.text = element_text(size = 9),
          axis.text.y = element_text(size = 9),
          axis.text.x = element_text(size = 9),
          legend.text = element_text(size = 9))  
p1
ggsave(file.path(output_dir, fw_t25fw_outcome_col, 't25fw_log_model4_FW_predicted_observed.png'), 
       bg = "white", width= 3, height= 3)

```
Fitted vs Residuals 
```{r}
fitted_vals <- fitted(t25fw_fw_multi_simple_results$object)
resid_vals <- resid(t25fw_fw_multi_simple_results$object)

resid_df <- data.frame(Fitted = fitted_vals, Residuals = resid_vals)

p2 <- ggplot(resid_df, aes(x = Fitted, y = Residuals)) +
  geom_point(alpha = 0.6, size = 0.75) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "grey") +
  labs(
    title = paste('Model 4: Fitted vs Residuals'),
    x = "Fitted Values",
    y = "Residuals"
  ) +
  coord_fixed(ratio = 1) +
  theme_minimal() + 
  theme(plot.title = element_text(size = 9, face = 'bold', hjust = 0.5),
          axis.title = element_text(size = 9),
          #axis.text = element_text(size = 9),
          axis.text.y = element_text(size = 9),
          axis.text.x = element_text(size = 9),
          legend.text = element_text(size = 9))  
print(p2)
p2
ggsave(file.path(output_dir, fw_t25fw_outcome_col, 't25fw_log_model4_FW_residuals_fitted.png'), 
       bg = "white", width= 3, height= 3)
```




## Home Videos 
### Check outcome transforms  
```{r}
y_outcome_cols <- c("clean_T25FW_Avg", "t25fw_log", "t25fw_inverse", "t25fw_sqrt") 
#plot_outcome_transforms_vs_predictors(home_df, y_outcome_cols, 'home', output_dir)
```

### Set Outcome variable 
```{r}
home_t25fw_outcome_col = "t25fw_log"
```

### Drop rows with any missing video metrics 
Not all metrics could be calculated from each video metric 

Dropped videos missing any video metric so models could be compared 
```{r}
home_clean_df <- home_df %>% 
  drop_na(c("stride_time_median_sec_pose_hv", 
            "log_delta_pix_h_rel_median_pose_hv",
            "mean_cadence_step_per_min_pose_hv",
            "stride_width_median_cm_pose_hv"))

```

### Univariate Models 
```{r}
run_save_univariate(home_df, home_t25fw_outcome_col, 'Home', plot_x_adj = 1)
```


### Multivariate Demographics and MS Info 

```{r}
t25fw_home_multi_dem_formula <- as.formula(paste(home_t25fw_outcome_col, 
                                         "~ clean_Age +
                                         demoEHR_DiseaseDuration +
                                       ms_dx_condensed +
                                       (1|bw_id)"))

t25fw_home_multi_dem_results <- multivariate_save_results(formula = t25fw_home_multi_dem_formula,
                                               df = home_clean_df,
                                               outcome_column_str = home_t25fw_outcome_col,
                                               model_str = "Model 1")

t25fw_home_multi_dem_results$df
summary(t25fw_home_multi_dem_results$object)
```

### Multivariate Video Models - Unadjusted 
```{r}
t25fw_home_multi_metrics_formula <- as.formula(paste(home_t25fw_outcome_col, "~ stride_time_median_sec_pose_hv +
                                                      log_delta_pix_h_rel_median_pose_hv + 
                                                #      mean_cadence_step_per_min_pose_hv + 
                                                      stride_width_median_cm_pose_hv +
                                                      (1|bw_id)"))
t25fw_home_multi_metrics_formula

t25fw_home_multi_metrics_results <- multivariate_save_results(formula = t25fw_home_multi_metrics_formula,
                                               df = home_clean_df,
                                               outcome_column_str = home_t25fw_outcome_col,
                                               model_str = "Model 2") 
t25fw_home_multi_metrics_results$df
summary(t25fw_home_multi_metrics_results$object)
```


### Multivariate Video Models - Adjusted 
```{r}
# adjusted: Metrics and MS Info 

t25fw_home_multi_vid_adj_formula <- as.formula(paste(home_t25fw_outcome_col, 
                                                      "~ stride_time_median_sec_pose_hv +
                                                      log_delta_pix_h_rel_median_pose_hv + 
                                                  #    mean_cadence_step_per_min_pose_hv + 
                                                      stride_width_median_cm_pose_hv + 
                                                      clean_Age +
                                                      demoEHR_DiseaseDuration + 
                                                      ms_dx_condensed +
                                                      (1|bw_id)"))
t25fw_home_multi_vid_adj_formula


t25fw_home_multi_vid_adj_results <- multivariate_save_results(formula = t25fw_home_multi_vid_adj_formula,
                                               df = home_clean_df,
                                               outcome_column_str = home_t25fw_outcome_col,
                                               model_str = "Model 3") 
t25fw_home_multi_vid_adj_results$df
summary(t25fw_home_multi_vid_adj_results$object)
```

### ANOVA compare multivariate models 
Log likelihood tests 
p value < 0.05, more complex model is significantly better than the simpler model 

https://bookdown.org/ndphillips/YaRrr/comparing-regression-models-with-anova.html 
```{r}
# Demographics only vs Video + Demographics 
anova(t25fw_home_multi_dem_results$object, t25fw_home_multi_vid_adj_results$object)

# Video only vs Video + Demographics 
anova(t25fw_home_multi_metrics_results$object, t25fw_home_multi_vid_adj_results$object)
```

### Save Multivar results 
```{r}
bind_plot_multivar_results(t25fw_home_multi_dem_results$df,
                           t25fw_home_multi_metrics_results$df,
                           t25fw_home_multi_vid_adj_results$df, 
                           home_t25fw_outcome_col, 
                           'Home',
                           plot_x_adj = 1.5)
```

# Zeno Mat Velocity Mixed Effect Model 
## Plot and transform Zeno mat velocity  

Preferred Walking Speed 
```{r}
# preferred walking speed 
ggplot(data = zeno_pws_df, mapping = aes(PWS_velocitycmsecmean)) + 
  geom_histogram()

# log 
zeno_pws_df$PWS_velocity_log <- log(zeno_pws_df$PWS_velocitycmsecmean)
ggplot(data = zeno_pws_df, mapping = aes(PWS_velocity_log)) + 
  geom_histogram()

# inverse  
zeno_pws_df$PWS_velocity_inv <- 1 / zeno_pws_df$PWS_velocitycmsecmean
ggplot(data = zeno_pws_df, mapping = aes(PWS_velocity_inv)) + 
  geom_histogram()

# sqrt
zeno_pws_df$PWS_velocity_sqrt <- sqrt(zeno_pws_df$PWS_velocitycmsecmean)
ggplot(data = zeno_pws_df, mapping = aes(PWS_velocity_sqrt)) + 
  geom_histogram()
```

Fast Walking Speed 
```{r}
# fast walking speed 
ggplot(data = zeno_fw_df, mapping = aes(FW_velocitycmsecmean)) + 
  geom_histogram()

# log 
zeno_fw_df$FW_velocity_log <- log(zeno_fw_df$FW_velocitycmsecmean)
ggplot(data = zeno_fw_df, mapping = aes(FW_velocity_log)) + 
  geom_histogram()

# inverse  
zeno_fw_df$FW_velocity_inv <- 1 / zeno_fw_df$FW_velocitycmsecmean
ggplot(data = zeno_fw_df, mapping = aes(FW_velocity_inv)) + 
  geom_histogram()

# square root 
zeno_fw_df$FW_velocity_sqrt <- sqrt(zeno_fw_df$FW_velocitycmsecmean)
ggplot(data = zeno_fw_df, mapping = aes(FW_velocity_sqrt)) + 
  geom_histogram()
```

Home Videos - most recent PWS and FW from mat 

```{r}

# preferred walking speed 

# home videos 
ggplot(data = home_df, mapping = aes(PWS_velocitycmsecmean)) + 
  geom_histogram()

# log 
home_df$PWS_velocity_log <- log(home_df$PWS_velocitycmsecmean)
ggplot(data = home_df, mapping = aes(PWS_velocity_log)) + 
  geom_histogram()

# inverse  
home_df$PWS_velocity_inv <- 1 / home_df$PWS_velocitycmsecmean
ggplot(data = home_df, mapping = aes(PWS_velocity_inv)) + 
  geom_histogram()

# square root 
home_df$PWS_velocity_sqrt <- sqrt(home_df$PWS_velocitycmsecmean)
ggplot(data = home_df, mapping = aes(PWS_velocity_sqrt)) + 
  geom_histogram()
################################################

#FW 
ggplot(data = home_df, mapping = aes(FW_velocitycmsecmean)) + 
  geom_histogram()

# log 
home_df$FW_velocity_log <- log(home_df$FW_velocitycmsecmean)
ggplot(data = home_df, mapping = aes(FW_velocity_log)) + 
  geom_histogram()

# inverse  
home_df$FW_velocity_inv <- 1 / home_df$FW_velocitycmsecmean
ggplot(data = home_df, mapping = aes(FW_velocity_inv)) + 
  geom_histogram()

# square root 
home_df$FW_velocity_sqrt <- sqrt(home_df$FW_velocitycmsecmean)
ggplot(data = home_df, mapping = aes(FW_velocity_sqrt)) + 
  geom_histogram()

```

## Make output folder for each zeno walking speed outcome 

```{r}
output_folders <- c("PWS_velocitycmsecmean", "PWS_velocity_log", "PWS_velocity_inv", "PWS_velocity_sqrt",
                    "FW_velocitycmsecmean", "FW_velocity_log", "FW_velocity_inv", "FW_velocity_sqrt")

for (i in seq_along(output_folders)){
  
  print(output_folders[i])
  current_path <- file.path(output_dir, output_folders[i])
  
  if (file.exists(current_path) == FALSE){
    dir.create(current_path)
    }
}
```

## Preferred Walking speed videos 
### Check outcome transforms and select metrics 
```{r}
y_outcome_cols <- c("PWS_velocitycmsecmean", "PWS_velocity_log", "PWS_velocity_inv", "PWS_velocity_sqrt") 
#plot_outcome_transforms_vs_predictors(zeno_pws_df, y_outcome_cols, 'pws', output_dir)
```

### Set Outcome variable 
```{r}
pws_pwsVel_outcome_col = "PWS_velocitycmsecmean"
```

### Univariate Models 
```{r}
run_save_univariate(zeno_pws_df, pws_pwsVel_outcome_col, 'PWS', plot_x_adj = 55)
```

### Multivariate Demographics and MS Info
```{r}
pws_pwsVel_multi_dem_formula <- as.formula(paste(pws_pwsVel_outcome_col, 
                                         "~ clean_Age +
                                         demoEHR_DiseaseDuration +
                                         ms_dx_condensed +
                                         (1|bw_id)"))

pws_pwsVel_multi_dem_results <- multivariate_save_results(formula = pws_pwsVel_multi_dem_formula,
                                               df = zeno_pws_clean_df,
                                               outcome_column_str = pws_pwsVel_outcome_col,
                                               model_str = "Model 1")

pws_pwsVel_multi_dem_results$df
summary(pws_pwsVel_multi_dem_results$object)

```

### Multivariate Video Models - Unadjusted 
```{r}
pws_pwsVel_multi_metrics_formula <- as.formula(paste(pws_pwsVel_outcome_col, "~ stride_time_median_sec_pose_zv +
                                                      delta_pix_h_rel_median_pose_zv + 
                                                    #  mean_cadence_step_per_min_pose_zv + 
                                                      stride_width_median_cm_pose_zv +
                                                      (1|bw_id)"))
pws_pwsVel_multi_metrics_formula

pws_pwsVel_multi_metrics_results <- multivariate_save_results(formula = pws_pwsVel_multi_metrics_formula,
                                               df = zeno_pws_clean_df,
                                               outcome_column_str = pws_pwsVel_outcome_col,
                                               model_str = "Model 2") 
pws_pwsVel_multi_metrics_results$df
summary(pws_pwsVel_multi_metrics_results$object)
```

### Multivariate Video Models - Adjusted  
```{r}

pws_pwsVel_multi_vid_adj_formula <- as.formula(paste(pws_pwsVel_outcome_col, 
                                                      "~ stride_time_median_sec_pose_zv +
                                                      delta_pix_h_rel_median_pose_zv + 
                                                 #     mean_cadence_step_per_min_pose_zv + 
                                                      stride_width_median_cm_pose_zv + 
                                                      clean_Age +
                                                      demoEHR_DiseaseDuration + 
                                                      ms_dx_condensed +
                                                      (1|bw_id)"))
pws_pwsVel_multi_vid_adj_formula


pws_pwsVel_multi_vid_adj_results <- multivariate_save_results(formula = pws_pwsVel_multi_vid_adj_formula,
                                               df = zeno_pws_clean_df,
                                               outcome_column_str = pws_pwsVel_outcome_col,
                                               model_str = "Model 3") 
pws_pwsVel_multi_vid_adj_results$df
summary(pws_pwsVel_multi_vid_adj_results$object)
```




### ANOVA - Compare Multivar Models 
p value < 0.05, more complex model is significantly better than the simpler model 

https://bookdown.org/ndphillips/YaRrr/comparing-regression-models-with-anova.html 
```{r}
# Demographics only vs Video + Demographics 
anova(pws_pwsVel_multi_dem_results$object, pws_pwsVel_multi_vid_adj_results$object)

# Video only vs Video + Demographics 
anova(pws_pwsVel_multi_metrics_results$object, pws_pwsVel_multi_vid_adj_results$object)
```


### Save all Multivar results 
```{r}
bind_plot_multivar_results(pws_pwsVel_multi_dem_results$df,
                           pws_pwsVel_multi_metrics_results$df,
                           pws_pwsVel_multi_vid_adj_results$df, 
                           pws_pwsVel_outcome_col, 
                           'PWS',
                           plot_x_adj = 35)
```

## Fast Walking speed videos 
### Check outcome transforms and select metrics 
```{r}
y_outcome_cols <- c("FW_velocitycmsecmean", "FW_velocity_log", "FW_velocity_inv", "FW_velocity_sqrt") 
#plot_outcome_transforms_vs_predictors(zeno_fw_df, y_outcome_cols, 'FW', output_dir)
```

### Set Outcome variable 
```{r}
fw_fwVel_outcome_col = "FW_velocitycmsecmean"
```


### Univariate Models
```{r}
run_save_univariate(zeno_fw_df, fw_fwVel_outcome_col, 'FW', plot_x_adj = 50)
```




### Multivariate Demographics and MS Info

```{r}
fw_fwVel_multi_dem_formula <- as.formula(paste(fw_fwVel_outcome_col, 
                                         "~ clean_Age +
                                         demoEHR_DiseaseDuration +
                                         ms_dx_condensed +
                                         (1|bw_id)"))

fw_fwVel_multi_dem_results <- multivariate_save_results(formula = fw_fwVel_multi_dem_formula,
                                               df = zeno_fw_clean_df,
                                               outcome_column_str = fw_fwVel_outcome_col,
                                               model_str = "Model 1")

fw_fwVel_multi_dem_results$df
summary(fw_fwVel_multi_dem_results$object)
```

### Multivariate Video Models - Unadjusted 
```{r}
fw_fwVel_multi_metrics_formula <- as.formula(paste(fw_fwVel_outcome_col, "~ stride_time_median_sec_pose_zv +
                                                      delta_pix_h_rel_median_pose_zv + 
                                                   #   mean_cadence_step_per_min_pose_zv + 
                                                      stride_width_median_cm_pose_zv + 
                                                      (1|bw_id)"))
fw_fwVel_multi_metrics_formula

fw_fwVel_multi_metrics_results <- multivariate_save_results(formula = fw_fwVel_multi_metrics_formula,
                                               df = zeno_fw_clean_df,
                                               outcome_column_str = fw_fwVel_outcome_col,
                                               model_str = "Model 2") 
fw_fwVel_multi_metrics_results$df
summary(fw_fwVel_multi_metrics_results$object)
```

### Multivariate Video Models - Adjusted  

```{r}
fw_fwVel_multi_vid_adj_formula <- as.formula(paste(fw_fwVel_outcome_col, 
                                                      "~ stride_time_median_sec_pose_zv +
                                                      delta_pix_h_rel_median_pose_zv + 
                                                   #   mean_cadence_step_per_min_pose_zv + 
                                                      stride_width_median_cm_pose_zv + 
                                                      clean_Age +
                                                      demoEHR_DiseaseDuration + 
                                                      ms_dx_condensed +
                                                      (1|bw_id)"))
fw_fwVel_multi_vid_adj_formula


fw_fwVel_multi_vid_adj_results <- multivariate_save_results(formula = fw_fwVel_multi_vid_adj_formula,
                                               df = zeno_fw_clean_df,
                                               outcome_column_str = fw_fwVel_outcome_col,
                                               model_str = "Model 3") 
fw_fwVel_multi_vid_adj_results$df
summary(fw_fwVel_multi_vid_adj_results$object)
```


### ANOVA - Compare Multivar Models 
p value < 0.05, more complex model is significantly better than the simpler model 

https://bookdown.org/ndphillips/YaRrr/comparing-regression-models-with-anova.html 
```{r}
# Demographics only vs Video + Demographics 
anova(fw_fwVel_multi_dem_results$object, fw_fwVel_multi_vid_adj_results$object)

# Video only vs Video + Demographics 
anova(fw_fwVel_multi_metrics_results$object, fw_fwVel_multi_vid_adj_results$object)
```

### Save all Multivar results 
```{r}
bind_plot_multivar_results(fw_fwVel_multi_dem_results$df,
                           fw_fwVel_multi_metrics_results$df,
                           fw_fwVel_multi_vid_adj_results$df, 
                           fw_fwVel_outcome_col, 
                           'FW',
                           plot_x_adj = 50)
```

## Home Videos: FW Velocity Outcome 
### Check outcome transforms and select metrics 
```{r}
y_outcome_cols <- c("FW_velocitycmsecmean", "FW_velocity_log", "FW_velocity_inv", "FW_velocity_sqrt") 
#plot_outcome_transforms_vs_predictors(home_df, y_outcome_cols, 'home', output_dir)
```

### Set outcome variable 
```{r}
home_fwVel_outcome_col = "FW_velocitycmsecmean"
```


### Univariate Models 
```{r}
run_save_univariate(home_df, home_fwVel_outcome_col, 'Home', plot_x_adj = 30)
```


### Multivariate Demographics and MS Info
```{r}
home_fwVel_multi_dem_formula <- as.formula(paste(home_fwVel_outcome_col, 
                                         "~ clean_Age +
                                         demoEHR_DiseaseDuration +
                                         ms_dx_condensed +
                                         (1|bw_id)"))

home_fwVel_multi_dem_results <- multivariate_save_results(formula = home_fwVel_multi_dem_formula,
                                               df = home_clean_df,
                                               outcome_column_str = home_fwVel_outcome_col,
                                               model_str = "Model 1")

home_fwVel_multi_dem_results$df
summary(home_fwVel_multi_dem_results$object)
```
### Multivariate Video Models - Unadjusted 

```{r}
home_fwVel_multi_metrics_formula <- as.formula(paste(home_fwVel_outcome_col, "~ stride_time_median_sec_pose_hv +
                                                      delta_pix_h_rel_median_pose_hv + 
                                                  #    mean_cadence_step_per_min_pose_hv + 
                                                      stride_width_median_cm_pose_hv + 
                                                      (1|bw_id)"))
home_fwVel_multi_metrics_formula

home_fwVel_multi_metrics_results <- multivariate_save_results(formula = home_fwVel_multi_metrics_formula,
                                               df = home_clean_df,
                                               outcome_column_str = home_fwVel_outcome_col,
                                               model_str = "Model 2") 
home_fwVel_multi_metrics_results$df
summary(home_fwVel_multi_metrics_results$object)
```
### Multivariate Video Models - Adjusted  
```{r}
home_fwVel_multi_vid_adj_formula <- as.formula(paste(home_fwVel_outcome_col, 
                                                      "~ stride_time_median_sec_pose_hv +
                                                      delta_pix_h_rel_median_pose_hv + 
                                                  #    mean_cadence_step_per_min_pose_hv + 
                                                      stride_width_median_cm_pose_hv + 
                                                      clean_Age +
                                                      demoEHR_DiseaseDuration + 
                                                      ms_dx_condensed +
                                                      (1|bw_id)"))
home_fwVel_multi_vid_adj_formula


home_fwVel_multi_vid_adj_results <- multivariate_save_results(formula = home_fwVel_multi_vid_adj_formula,
                                               df = home_clean_df,
                                               outcome_column_str = home_fwVel_outcome_col,
                                               model_str = "Model 3") 
home_fwVel_multi_vid_adj_results$df
summary(home_fwVel_multi_vid_adj_results$object)

```
### ANOVA - Compare Multivar Models 
p value < 0.05, more complex model is significantly better than the simpler model 

https://bookdown.org/ndphillips/YaRrr/comparing-regression-models-with-anova.html 
```{r}
# Demographics only vs Video + Demographics 
anova(home_fwVel_multi_dem_results$object, home_fwVel_multi_vid_adj_results$object)

# Video only vs Video + Demographics 
anova(home_fwVel_multi_metrics_results$object, home_fwVel_multi_vid_adj_results$object)
```

### Save all multivar results 

```{r}
bind_plot_multivar_results(home_fwVel_multi_dem_results$df,
                           home_fwVel_multi_metrics_results$df,
                           home_fwVel_multi_vid_adj_results$df, 
                           home_fwVel_outcome_col, 
                           'Home',
                           plot_x_adj = 50)
```


## Home Videos: PWS Velocity Outcome 
### Check outcome transforms and select metrics 
```{r}
y_outcome_cols <- c("PWS_velocitycmsecmean", "PWS_velocity_log", "PWS_velocity_inv", "PWS_velocity_sqrt") 
#plot_outcome_transforms_vs_predictors(home_df, y_outcome_cols, 'home', output_dir)
```

### Set outcome variable 
```{r}
home_pwsVel_outcome_col = "PWS_velocitycmsecmean"
```

### Univariate Models 
```{r}
run_save_univariate(home_df, home_pwsVel_outcome_col, 'Home', plot_x_adj = 30)

```

### Multivariate Demographics and MS Info
```{r}
home_pwsVel_multi_dem_formula <- as.formula(paste(home_pwsVel_outcome_col, 
                                         "~ clean_Age +
                                         demoEHR_DiseaseDuration +
                                         ms_dx_condensed +
                                         (1|bw_id)"))

home_pwsVel_multi_dem_results <- multivariate_save_results(formula = home_pwsVel_multi_dem_formula,
                                               df = home_clean_df,
                                               outcome_column_str = home_pwsVel_outcome_col,
                                               model_str = "Model 1")

home_pwsVel_multi_dem_results$df
summary(home_pwsVel_multi_dem_results$object)
```
### Multivariate Video Models - Unadjusted 

```{r}
home_pwsVel_multi_metrics_formula <- as.formula(paste(home_pwsVel_outcome_col, "~ stride_time_median_sec_pose_hv +
                                                      delta_pix_h_rel_median_pose_hv + 
                                                     # mean_cadence_step_per_min_pose_hv + 
                                                      stride_width_median_cm_pose_hv + 
                                                      (1|bw_id)"))
home_pwsVel_multi_metrics_formula

home_pwsVel_multi_metrics_results <- multivariate_save_results(formula = home_pwsVel_multi_metrics_formula,
                                               df = home_clean_df,
                                               outcome_column_str = home_pwsVel_outcome_col,
                                               model_str = "Model 2") 
home_pwsVel_multi_metrics_results$df
summary(home_pwsVel_multi_metrics_results$object)
```
### Multivariate Video Models - Adjusted  
```{r}
home_pwsVel_multi_vid_adj_formula <- as.formula(paste(home_pwsVel_outcome_col, 
                                                      "~ stride_time_median_sec_pose_hv +
                                                      delta_pix_h_rel_median_pose_hv + 
                                                     # mean_cadence_step_per_min_pose_hv + 
                                                      stride_width_median_cm_pose_hv + 
                                                      clean_Age +
                                                      demoEHR_DiseaseDuration + 
                                                      ms_dx_condensed +
                                                      (1|bw_id)"))
home_pwsVel_multi_vid_adj_formula


home_pwsVel_multi_vid_adj_results <- multivariate_save_results(formula = home_pwsVel_multi_vid_adj_formula,
                                               df = home_clean_df,
                                               outcome_column_str = home_pwsVel_outcome_col,
                                               model_str = "Model 3") 
home_pwsVel_multi_vid_adj_results$df
summary(home_pwsVel_multi_vid_adj_results$object)

```
### ANOVA - Compare Multivar Models 
p value < 0.05, more complex model is significantly better than the simpler model 

https://bookdown.org/ndphillips/YaRrr/comparing-regression-models-with-anova.html 
```{r}
# Demographics only vs Video + Demographics 
anova(home_pwsVel_multi_dem_results$object, home_pwsVel_multi_vid_adj_results$object)

# Video only vs Video + Demographics 
anova(home_pwsVel_multi_metrics_results$object, home_pwsVel_multi_vid_adj_results$object)

```
### Save all Multivar results 
```{r}
bind_plot_multivar_results(home_pwsVel_multi_dem_results$df,
                           home_pwsVel_multi_metrics_results$df,
                           home_pwsVel_multi_vid_adj_results$df, 
                           home_pwsVel_outcome_col, 
                           'Home',
                           plot_x_adj = 50)
```
